# 5.2 输出 PWM 波形 (呼吸灯/舵机)

## 1. PWM 原理

**PWM (脉冲宽度调制)**：通过控制数字信号高电平的持续时间（占空比），来模拟模拟电压输出。
*   **ARR** 决定频率（周期）。
*   **CCR (Capture Compare Register)** 决定占空比。
*   **PWM模式1**：CNT < CCR 时输出有效电平。

## 2. 配置步骤 (以 TIM2_CH1 为例)

注意：TIM2 的 CH1 引脚默认复用在 **PA0** 上。

### 前置步骤
除了配置时基单元（同 5.1 节），还需要配置 GPIO 为 **复用推挽输出 (AF_PP)**。

```c
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP; // 重要！
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0;
```

### 配置输出比较单元 (OC)
```c
TIM_OCInitTypeDef TIM_OCInitStructure;
TIM_OCStructInit(&TIM_OCInitStructure); // 给结构体赋默认值，防止未配置成员导致错误
TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; // PWM模式1
TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High; // 有效电平为高
TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;
TIM_OCInitStructure.TIM_Pulse = 0; // 初始 CCR 值
TIM_OC1Init(TIM2, &TIM_OCInitStructure); // 初始化通道 1
```

## 3. 应用案例

### 呼吸灯
在 `main` 循环中不断修改 CCR 值。
```c
TIM_SetCompare1(TIM2, i); // 修改 CCR1
```

### 驱动舵机 (SG90)
舵机要求周期为 **20ms (50Hz)**。
*   PSC = 72 - 1, ARR = 20000 - 1 (1MHz计数频率，20k计数就是20ms)
*   高电平时间 0.5ms ~ 2.5ms 对应 0度 ~ 180度。
    *   0度: CCR = 500
    *   180度: CCR = 2500