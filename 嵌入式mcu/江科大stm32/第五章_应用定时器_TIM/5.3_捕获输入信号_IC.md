# 5.3 捕获输入信号 (IC)

## 1. 输入捕获原理 (Input Capture)

定时器不仅能输出 PWM，也能接收外部方波信号，测量其**频率**和**占空比**。
*   **测频法**：在 T 时间内数脉冲个数（适合高频）。
*   **测周法**：测量一个脉冲周期的标准时钟个数（适合低频）。**STM32 使用此法。**

## 2. 核心配置：PWMI 模式

STM32 提供了硬件电路，可以用两个通道同时捕获同一个引脚：
*   **通道1 (IC1)**：捕获上升沿，作为周期的开始，并触发 **从模式复位 (Reset Mode)**，将 CNT 清零。
*   **通道2 (IC2)**：捕获下降沿，此时 CNT 的值就是高电平时间。
*   下一个上升沿到来：IC1 再次捕获 CNT（即整个周期时间），并再次清零 CNT。

### 关键代码
```c
TIM_ICInitTypeDef TIM_ICInitStructure;
TIM_ICInitStructure.TIM_Channel = TIM_Channel_1;
TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising; // 周期结束/开始
TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;
TIM_ICInitStructure.TIM_ICFilter = 0xF;
TIM_ICInit(TIM3, &TIM_ICInitStructure);

// PWMI 自动配置函数（会自动把通道2配置为相反极性、交叉输入）
TIM_PWMIConfig(TIM3, &TIM_ICInitStructure);

// 配置主从模式：TI1FP1 触发 Reset
TIM_SelectInputTrigger(TIM3, TIM_TS_TI1FP1);
TIM_SelectSlaveMode(TIM3, TIM_SlaveMode_Reset);

TIM_Cmd(TIM3, ENABLE);
```

## 3. 读取结果

*   **频率**：`Freq = 标准频率 (72M/PSC) / TIM_GetCapture1(TIM3)`
*   **占空比**：`Duty = TIM_GetCapture2(TIM3) / TIM_GetCapture1(TIM3)`