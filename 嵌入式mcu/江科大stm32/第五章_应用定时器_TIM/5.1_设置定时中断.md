# 5.1 设置定时中断

## 1. 定时器基础

STM32 的通用定时器（TIM2/3/4/5）是一个 16 位的计数器。
*   **核心逻辑**：计数器 (CNT) 在时钟驱动下不断自增，当达到自动重装载值 (ARR) 时，产生更新事件 (Update Event) 并清零，重新计数。
*   **时间计算公式**：
    $$ \text{时间} = \frac{(\text{PSC} + 1) \times (\text{ARR} + 1)}{72000000} $$
    *   **PSC (Prescaler)**：预分频系数（0~65535）。
    *   **ARR (AutoReload Register)**：自动重装值（0~65535）。
    *   **72MHz**：APB1 总线时钟通常为 72MHz。

**示例**：要产生 1秒 的中断。
*   PSC = 7200 - 1
*   ARR = 10000 - 1
*   Freq = 72M / 7200 / 10000 = 1Hz (1s)

## 2. 配置步骤

### 第一步：开启时钟
```c
RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);
```

### 第二步：选择时基
通常使用内部时钟。
```c
TIM_InternalClockConfig(TIM2);
```

### 第三步：配置时基单元 (TimeBase)
```c
TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;
TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1;
TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up; // 向上计数
TIM_TimeBaseStructure.TIM_Period = 10000 - 1;   // ARR
TIM_TimeBaseStructure.TIM_Prescaler = 7200 - 1; // PSC
TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);
```

### 第四步：开启更新中断与 NVIC
```c
TIM_ClearFlag(TIM2, TIM_FLAG_Update); // 清除标志位，避免刚初始化完就进一次中断
TIM_ITConfig(TIM2, TIM_IT_Update, ENABLE);

// 配置 NVIC (同上章，通道为 TIM2_IRQn)
NVIC_InitTypeDef NVIC_InitStructure;
NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn;
// ... (优先级配置)
NVIC_Init(&NVIC_InitStructure);
```

### 第五步：启动定时器
```c
TIM_Cmd(TIM2, ENABLE);
```

## 3. 中断服务函数

```c
void TIM2_IRQHandler(void)
{
    if (TIM_GetITStatus(TIM2, TIM_IT_Update) == SET)
    {
        // 执行定时任务
        // ...
        TIM_ClearITPendingBit(TIM2, TIM_IT_Update); // 清除标志位
    }
}
```