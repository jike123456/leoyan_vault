# 6.2 搬运数据 (DMA)

## 1. 为什么需要 DMA？

当我们需要采集多通道 ADC 数据（例如 4 个传感器）时：
*   如果使用非扫描模式：需要手动切换通道，效率低。
*   如果使用扫描模式：ADC 会依次转换通道 1, 2, 3, 4，但数据都会覆盖到同一个数据寄存器 (`DR`) 中。如果不及时取走，数据就会丢失。
*   **DMA 作用**：一旦 ADC 产生数据，DMA 自动“搬运”到内存数组中，全程无需 CPU 参与。

## 2. ADC + DMA 配置流程

**目标**：连续扫描 4 个通道，存入 `AD_Value[4]` 数组。

### DMA 初始化 (DMA1_Channel1)
STM32F103 的 ADC1 请求固定连接在 DMA1 的通道 1 上。

```c
RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE); // DMA 挂在 AHB 总线

DMA_InitTypeDef DMA_InitStructure;
// 1. 源地址：ADC1 的数据寄存器地址
DMA_InitStructure.DMA_PeripheralBaseAddr = (uint32_t)&ADC1->DR;
DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord; // 16位
DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable; // 外设地址不增

// 2. 目的地址：SRAM 中的数组
DMA_InitStructure.DMA_MemoryBaseAddr = (uint32_t)AD_Value;
DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;
DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable; // 内存地址自增

// 3. 传输方向与数量
DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC; // 外设 -> 内存
DMA_InitStructure.DMA_BufferSize = 4; // 传输 4 个数据
DMA_InitStructure.DMA_Mode = DMA_Mode_Circular; // 循环模式 (重要！)
DMA_InitStructure.DMA_M2M = DMA_M2M_Disable; // 非内存到内存
DMA_InitStructure.DMA_Priority = DMA_Priority_High;

DMA_Init(DMA1_Channel1, &DMA_InitStructure);
DMA_Cmd(DMA1_Channel1, ENABLE);
```

### ADC 配置修改
1.  **开启扫描模式**：`ADC_ScanConvMode = ENABLE`。
2.  **开启连续转换**：`ADC_ContinuousConvMode = ENABLE`。
3.  **通道数**：`ADC_NbrOfChannel = 4`。
4.  **配置 4 个规则通道**。
5.  **开启 ADC 到 DMA 的请求**：
    ```c
    ADC_DMACmd(ADC1, ENABLE); // 关键一步
    ```
6.  **触发一次**：`ADC_SoftwareStartConvCmd(ADC1, ENABLE)`，之后 DMA 就会自动不停地搬运数据了。