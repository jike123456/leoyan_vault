# 6.1 采集模拟信号 (AD单/多通道)

## 1. ADC 基础参数

*   **STM32F103**：拥有 1~2 个 ADC，12 位分辨率 (0~4095)。
*   **输入电压**：0 ~ 3.3V。转换结果 = $Voltage / 3.3 \times 4095$。
*   **转换时间**：最快 1us。采样时间 + 12.5 个周期。
*   **时钟**：ADC 预分频器最大允许 14MHz。通常设为 **72M / 6 = 12MHz**。

## 2. 单通道采集步骤 (电位器/光敏传感器)

### 第一步：配置时钟与分频
```c
RCC_APB2PeriphClockCmd(RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC1 | RCC_APB2Periph_GPIOA, ENABLE);
RCC_ADCCLKConfig(RCC_PCLK2_Div6); // 72M/6 = 12M
```

### 第二步：配置 GPIO (模拟输入)
```c
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN; // 模拟输入模式，断开数字逻辑
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0;
GPIO_Init(GPIOA, &GPIO_InitStructure);
```

### 第三步：配置规则组通道
将 PA0 (通道0) 放在规则组序列的第 1 位。
```c
ADC_RegularChannelConfig(ADC1, ADC_Channel_0, 1, ADC_SampleTime_55Cycles5);
```

### 第四步：初始化 ADC
```c
ADC_InitTypeDef ADC_InitStructure;
ADC_InitStructure.ADC_Mode = ADC_Mode_Independent; // 独立模式
ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right; // 右对齐
ADC_InitStructure.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None; // 软件触发
ADC_InitStructure.ADC_ContinuousConvMode = DISABLE; // 单次转换
ADC_InitStructure.ADC_ScanConvMode = DISABLE; // 非扫描
ADC_InitStructure.ADC_NbrOfChannel = 1;
ADC_Init(ADC1, &ADC_InitStructure);
```

### 第五步：开启与校准 (固定流程)
```c
ADC_Cmd(ADC1, ENABLE);

ADC_ResetCalibration(ADC1);
while (ADC_GetResetCalibrationStatus(ADC1));
ADC_StartCalibration(ADC1);
while (ADC_GetCalibrationStatus(ADC1));
```

### 第六步：读取数据
```c
ADC_SoftwareStartConvCmd(ADC1, ENABLE); // 触发一次
while (ADC_GetFlagStatus(ADC1, ADC_FLAG_EOC) == RESET); // 等待转换完成
return ADC_GetConversionValue(ADC1); // 读结果
```