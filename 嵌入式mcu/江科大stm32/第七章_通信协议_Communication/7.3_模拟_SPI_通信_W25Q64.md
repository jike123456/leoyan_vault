# 7.3 模拟 SPI 通信 (W25Q64)

## 1. SPI 基础

*   **四根线**：
    *   SS (CS): 片选，低电平有效。
    *   SCK: 时钟。
    *   MOSI: 主机输出从机输入。
    *   MISO: 主机输入从机输出。
*   **模式 0 (常用)**：CPOL=0 (空闲低电平), CPHA=0 (第 1 个边沿采样)。

## 2. 软件模拟 SPI 交换字节

SPI 是全双工的，发送一个字节的同时，必然接收一个字节。

```c
// 模式 0 交换逻辑
uint8_t MySPI_SwapByte(uint8_t ByteSend)
{
    uint8_t ByteReceive = 0x00;
    
    for (uint8_t i = 0; i < 8; i++)
    {
        // 1. 主机写 MOSI (在 SCK 上升沿之前准备好数据)
        MySPI_W_MOSI(ByteSend & 0x80); // 取最高位
        ByteSend <<= 1;
        
        // 2. 拉高 SCK (从机读取 MOSI，主机读取 MISO)
        MySPI_W_SCK(1);
        if (MySPI_R_MISO() == 1) ByteReceive |= 0x01;
        ByteReceive <<= 1;
        
        // 3. 拉低 SCK (为下一位做准备)
        MySPI_W_SCK(0);
    }
    return ByteReceive;
}
```

## 3. W25Q64 Flash 操作流程

Flash 存储器的特性：**写入前必须擦除，擦除后全为 1，数据只能由 1 改写为 0。**

### 读取 ID (指令 0x9F)
```c
MySPI_Start();
MySPI_SwapByte(0x9F); // 发送指令
MID = MySPI_SwapByte(0xFF); // 发送空字节交换回厂商 ID
DID = MySPI_SwapByte(0xFF); // 发送空字节交换回设备 ID
MySPI_Stop();
```

### 写入数据 (页编程)
1.  **写使能**：发送指令 `0x06`。
2.  **等待忙**：读取状态寄存器 1，等待 BUSY 位清零。
3.  **页编程**：
    *   发送指令 `0x02`。
    *   发送 24位 地址 (A23-A0)。
    *   连续发送数据 (最多 256 字节/页)。
    *   Stop。
    *   **再次等待忙** (写入需要时间，约 ms 级)。