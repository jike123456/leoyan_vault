# 4.1 配置外部中断 (EXTI)

## 1. 中断系统流程

STM32 的外部中断信号流程如下：
**GPIO 引脚 -> AFIO 数据选择器 -> EXTI 外部中断控制器 -> NVIC 嵌套向量中断控制器 -> CPU 处理**

## 2. 核心配置步骤

要使用 PB14 引脚触发中断，步骤非常严谨：

### 第一步：配置时钟 (RCC)
需要开启 GPIO 和 **AFIO** 的时钟。AFIO 负责引脚重映射和中断引脚选择。
```c
RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);
RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE); // 务必开启！
```

### 第二步：配置 GPIO
中断引脚通常配置为输入模式（浮空、上拉或下拉）。
```c
GPIO_InitTypeDef GPIO_InitStructure;
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU; // 上拉输入
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_14;
GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
GPIO_Init(GPIOB, &GPIO_InitStructure);
```

### 第三步：配置 AFIO (中断引脚选择)
告诉 STM32，EXTI 的第 14 号线路连接到 GPIOB 的第 14 号引脚。
```c
GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource14);
```

### 第四步：配置 EXTI
设置触发方式（下降沿、上升沿）和使能中断。
```c
EXTI_InitTypeDef EXTI_InitStructure;
EXTI_InitStructure.EXTI_Line = EXTI_Line14;
EXTI_InitStructure.EXTI_LineCmd = ENABLE;
EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;
EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling; // 下降沿触发
EXTI_Init(&EXTI_InitStructure);
```

### 第五步：配置 NVIC
设置优先级分组（整个工程通常只设置一次）和该中断通道的优先级。
```c
// 在 main 函数开头调用一次即可
NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); // 2位抢占，2位响应

NVIC_InitTypeDef NVIC_InitStructure;
NVIC_InitStructure.NVIC_IRQChannel = EXTI15_10_IRQn; // 10~15号引脚共用这个通道
NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;
NVIC_Init(&NVIC_InitStructure);
```

## 3. 编写中断服务函数 (ISR)

在 `stm32f10x_it.c` 或 `main.c` 中编写。函数名必须查启动文件（如 `EXTI15_10_IRQHandler`）。

```c
void EXTI15_10_IRQHandler(void)
{
    // 1. 判断标志位：确认是 EXTI14 触发的（因为 10-15 共用一个函数）
    if (EXTI_GetITStatus(EXTI_Line14) == SET)
    {
        // 2. 执行中断逻辑
        // Toggle_LED(); 
        
        // 3. 清除标志位：否则会一直卡在中断里！
        EXTI_ClearITPendingBit(EXTI_Line14);
    }
}
```

## 4. 注意事项
*   **通道共用**：EXTI0, EXTI1, EXTI2, EXTI3, EXTI4 有独立的中断通道；但 EXTI9_5 共用一个，EXTI15_10 共用一个。
*   **引脚冲突**：PA0, PB0, PC0 ... 只能有一个连接到 EXTI0 线路上。**即不能同时使用 PA0 和 PB0 的中断。**