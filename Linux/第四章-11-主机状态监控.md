# 第四章-11-主机状态监控

对Linux主机的状态进行监控是系统管理中至关重要的一环，它能帮助我们及时发现系统瓶颈、预测潜在问题并进行性能优化。本章将从系统资源（top）、磁盘和网络三个维度介绍常用的监控命令。

## 一、系统资源监控 (top 命令)

`top` 命令是 Linux 系统中最常用的性能分析工具，能够实时显示系统中各个进程的资源占用状况，类似于 Windows 的任务管理器。

### 1. `top` 命令基础
直接输入 `top` 即可启动。

**输出界面详解：**

```text
top - 10:30:00 up 1 day,  2:30,  2 users,  load average: 0.05, 0.10, 0.15
Tasks: 120 total,   1 running, 119 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1.0 us,  0.5 sy,  0.0 ni, 98.0 id,  0.2 wa,  0.0 hi,  0.3 si,  0.0 st
MiB Mem :   7890.0 total,   1200.0 free,   2500.0 used,   4190.0 buff/cache
MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.   5000.0 avail Mem 
```

*   **第一行（系统概况）**：
    *   `10:30:00`: 当前系统时间。
    *   `up 1 day...`: 系统已运行时间。
    *   `load average`: **平均负载**（关键指标）。三个数字分别代表 1分钟、5分钟、15分钟内的平均负载。
        *   *经验值*：如果数值超过了 CPU 核心数（如 4核CPU负载超过4），说明系统负载很高。
*   **第二行（任务/进程）**：
    *   `total`: 进程总数。
    *   `zombie`: **僵尸进程**数（需关注，如果过多说明有程序异常）。
*   **第三行（CPU状态）**：
    *   `us` (user): 用户空间占用 CPU 百分比。
    *   `sy` (system): 内核空间占用 CPU 百分比。
    *   `id` (idle): 空闲 CPU 百分比。
    *   `wa` (wait): **等待磁盘 I/O 的时间**（如果该值很高，说明磁盘读写是瓶颈）。
*   **第四、五行（内存与交换分区）**：
    *   `total`, `free`, `used`, `buff/cache`。
    *   注意：Linux 习惯把空闲内存挪作缓存（buff/cache），所以 `free` 很小不代表内存不够，主要看 `avail Mem`。

### 2. `top` 交互快捷键
在 `top` 运行界面中，可以使用以下按键：

*   **`P`** (大写)：按 **CPU** 使用率排序（默认）。
*   **`M`** (大写)：按 **内存** 使用率排序。
*   **`1`** (数字1)：展开/收起多核 CPU 的详细显示。
*   **`c`**：切换显示命令的完整路径。
*   **`k`**：终止一个进程（输入 PID 后回车）。
*   **`q`**：退出 top。

### 3. 其他辅助命令
除了 `top`，还有两个命令常配合使用：
*   **`uptime`**：仅显示 top 的第一行（负载信息）。
*   **`free -h`**：仅显示 top 的内存部分（更直观）。

---

## 二、磁盘监控

磁盘监控主要关注两个方面：**空间使用率** 和 **I/O 读写性能**。

### 1. 查看空间使用 (`df`)
`df` (Disk Free) 用于查看文件系统的磁盘空间占用情况。

```bash
df -h
```
*   `-h`: 以人类可读的格式（G, M）显示。
*   **关注点**：`Use%` 列。如果某个分区（特别是根目录 `/` 或数据目录）达到 90% 以上，需要及时清理。

### 2. 查看目录大小 (`du`)
`du` (Disk Usage) 用于分析具体是哪个文件夹占用了空间。

```bash
du -sh *   # 查看当前目录下每个子文件/文件夹的大小
du -sh /var/log  # 查看指定目录的大小
```

### 3. 磁盘 I/O 性能 (`iostat`)
如果系统卡顿但 CPU 不高，很可能是磁盘读写慢。`iostat` 是神器。

```bash
# 每秒刷新一次，共刷新3次
iostat -x 1 3
```

**核心指标解释：**
*   `rkB/s`, `wkB/s`: 每秒读/写的数据量（吞吐量）。
*   `%util`: **磁盘利用率**（最关键）。如果该值接近 100%，说明磁盘已经在全负荷运转，是系统瓶颈所在。
*   `await`: 平均每次 I/O 操作的等待时间。如果该值过高（如 >10ms），说明磁盘响应慢。

---

## 三、网络监控

网络监控主要关注带宽使用量和网络连通性。

### 1. 实时流量监控 (`sar`)
`sar` 是最通用的历史数据记录工具，也可以看实时网络。

```bash
# 每秒刷新一次，查看网络设备状态
sar -n DEV 1 3
```

**输出解读：**
*   `IFACE`: 网卡接口名称（如 eth0）。
*   `rxpck/s`, `txpck/s`: 每秒接收/发送的数据包数量。
*   `rxkB/s`, `txkB/s`: **每秒接收/发送的数据量**（带宽使用率）。

### 2. 简易流量查看 (`ifstat`)
如果你只想要一个简单的类似 top 的滚屏显示：

```bash
# 需先安装：yum install ifstat 或 apt install ifstat
ifstat
```

### 3. 网络连通性 (`ping`)
最基础但最有效的工具。

```bash
ping www.baidu.com
```
*   **作用**：测试能否上网，以及网络延迟（`time=xx ms`）。

---

## 四、总结

Linux 主机状态监控是一个多维度的过程：

1.  **CPU/负载**：首选 **`top`**。看 `load average` 是否过高，`us` 是否占用过多。
2.  **内存**：首选 **`free -h`**。看 `available` 是否充足。
3.  **磁盘空间**：首选 **`df -h`**。防止磁盘写满导致服务崩溃。
4.  **磁盘 I/O**：首选 **`iostat -x`**。看 `%util` 是否饱和。
5.  **网络**：首选 **`sar -n DEV`**。看 `rxkB/s` 和 `txkB/s` 是否异常。

熟练掌握这几个核心命令，足以应对 90% 的服务器运维场景。