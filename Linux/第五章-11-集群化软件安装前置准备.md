# 第五章-11-集群化软件安装前置准备

在部署Hadoop、Kafka、Zookeeper、Spark、Flink等分布式集群化软件之前，通常需要对集群中的每台机器进行一些前置准备和系统配置。这些准备工作是确保集群稳定、高效运行的基础。本节将介绍一些通用的前置准备步骤，适用于大多数Linux集群环境。

## 1. 节点规划与主机名配置

在分布式集群中，清晰的节点规划和正确的主机名配置是识别和管理各个节点的关键。

### 1.1 规划节点角色

根据集群的需求，为每台机器分配角色，例如：
*   **主节点 (Master/Leader)：** 负责协调、管理、调度。
*   **从节点 (Slave/Worker)：** 负责执行计算、存储数据。
*   **客户端节点 (Client)：** 运行应用程序。

例如，对于Hadoop，你可能需要一个NameNode、一个或多个DataNode。

### 1.2 配置主机名

每台机器都应该有一个唯一且易于识别的主机名。

**CentOS/RHEL：**
```bash
sudo hostnamectl set-hostname <your_hostname>
# 例如：
sudo hostnamectl set-hostname master-node
```

**Ubuntu/Debian：**
```bash
sudo hostnamectl set-hostname <your_hostname>
# 例如：
sudo hostnamectl set-hostname master-node
```
修改后，需要重启系统或重新登录以使主机名在所有shell会话中生效。

## 2. 配置主机映射 (hosts文件)

为了让集群中的节点可以通过主机名互相访问，而不是仅仅依赖IP地址，我们需要配置 `/etc/hosts` 文件。这在没有DNS服务器的简单集群环境中尤其重要。

编辑 `/etc/hosts` 文件，将集群中所有机器的IP地址和对应的主机名添加进去。
```bash
sudo vi /etc/hosts
```
**示例：**
```
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.1.101 master-node
192.168.1.102 slave-node-1
192.168.1.103 slave-node-2
```
确保在每台机器上都配置相同的内容。配置完成后，可以通过 `ping <hostname>` 来测试连通性。

## 3. SSH免密码登录配置

在集群环境中，主节点通常需要通过SSH免密码登录到所有从节点，以进行远程命令执行、文件传输等操作。这对于自动化管理和部署至关重要。

### 3.1 在主节点生成SSH密钥对

在主节点上，以运行集群服务的用户（例如`root`或`hadoop`用户）执行以下命令：
```bash
ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa
```
*   `-t rsa`: 指定密钥类型为RSA。
*   `-P ''`: 设置为空密码（免密码登录）。
*   `-f ~/.ssh/id_rsa`: 指定私钥文件路径。

这会在 `~/.ssh/` 目录下生成两个文件：`id_rsa`（私钥）和 `id_rsa.pub`（公钥）。

### 3.2 将公钥复制到所有从节点

使用 `ssh-copy-id` 命令将主节点的公钥复制到所有从节点上。
```bash
ssh-copy-id <user>@<slave_node_hostname>
# 例如：
ssh-copy-id root@slave-node-1
ssh-copy-id root@slave-node-2
```
在执行此命令时，会提示你输入从节点的密码。输入一次密码后，下次从主节点SSH登录到从节点就不再需要密码了。

**自我授权（主节点也能免密登录自己）：**
```bash
ssh-copy-id <user>@<master_node_hostname>
# 或者
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
```

### 3.3 测试SSH免密码登录

在主节点上尝试SSH登录到从节点，看是否需要输入密码。
```bash
ssh <user>@<slave_node_hostname>
```

## 4. 防火墙配置

为了集群内部通信的顺畅，通常需要开放一些端口。最简单但**不安全**的方法是直接关闭防火墙（**不推荐在生产环境中使用**）。更安全的方法是开放必要的端口。

### 4.1 关闭防火墙 (不推荐，仅用于测试环境)

**CentOS/RHEL (firewalld)：**
```bash
sudo systemctl stop firewalld
sudo systemctl disable firewalld
```

**Ubuntu/Debian (ufw)：**
```bash
sudo ufw disable
```

### 4.2 开放必要端口 (推荐)

根据不同集群软件的需求，开放相应的端口（例如Hadoop的9000, 9870, 8088等）。具体端口请参考各软件的安装文档。

## 5. 禁用SELinux (仅CentOS/RHEL)

SELinux（Security-Enhanced Linux）可能会阻止一些服务正常启动或访问文件，在某些集群环境中可能会造成不便。为了简化配置，有时会选择禁用SELinux。

**注意：禁用SELinux会降低系统安全性，请谨慎操作。**

### 5.1 临时禁用

```bash
sudo setenforce 0
```
（当前会话有效，重启后失效）

### 5.2 永久禁用

编辑 `/etc/selinux/config` 文件：
```bash
sudo vi /etc/selinux/config
```
将 `SELINUX=enforcing` 改为 `SELINUX=disabled`。
```
# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#       enforcing - SELinux security policy is enforced.
#       permissive - SELinux prints warnings instead of enforcing.
#       disabled - No SELinux policy is loaded.
SELINUX=disabled
# SELINUXTYPE= can take one of these two values:
#       targeted - Targeted processes are protected,
#       mls      - Multi Level Security protection.
SELINUXTYPE=targeted
```
修改后，需要重启系统才能完全生效。

## 6. 时间同步 (NTP)

在分布式系统中，各个节点之间的时间同步至关重要，它可以避免数据不一致、日志混乱等问题。

### 6.1 安装NTP服务

**CentOS/RHEL：**
```bash
sudo yum install ntp -y
```

**Ubuntu/Debian：**
```bash
sudo apt install ntp -y
```

### 6.2 配置NTP服务器

编辑 `/etc/ntp.conf`，将默认的NTP服务器修改为离你较近的公共NTP服务器或你自己的NTP服务器。
```bash
sudo vi /etc/ntp.conf
```
注释掉默认的 `server` 行，添加你自己的：
```
#server 0.centos.pool.ntp.org iburst
#server 1.centos.pool.ntp.org iburst
#server 2.centos.pool.ntp.org iburst
#server 3.centos.pool.ntp.org iburst

server ntp.aliyun.com iburst  # 阿里云NTP服务器
server ntp.tencent.com iburst # 腾讯云NTP服务器
server pool.ntp.org iburst    # 全球NTP服务器
```

### 6.3 启动并验证NTP服务

```bash
sudo systemctl start ntpd       # 启动NTP服务
sudo systemctl enable ntpd      # 设置开机自启
sudo systemctl status ntpd      # 检查服务状态

# 验证时间同步
ntpq -p
```
等待几分钟，`ntpq -p` 的输出中应该显示NTP服务器已经同步。

## 7. 安装Java环境 (如果集群软件需要)

大多数大数据和集群化软件都基于Java，因此需要安装合适的JDK版本。具体版本要求请参考相应软件的官方文档。

**CentOS/RHEL：**
```bash
sudo yum install java-1.8.0-openjdk-devel -y # 安装JDK 8
```

**Ubuntu/Debian：**
```bash
sudo apt install openjdk-8-jdk -y # 安装JDK 8
```

**配置JAVA_HOME环境变量：**
在 `/etc/profile` 或 `~/.bashrc` 中添加：
```bash
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64 # 根据实际路径修改
export PATH=$PATH:$JAVA_HOME/bin
```
然后 `source /etc/profile` 使其生效。

完成这些前置准备工作后，你的Linux节点就为部署复杂的集群化软件做好了准备。下一步就可以开始具体软件的安装和配置了。
