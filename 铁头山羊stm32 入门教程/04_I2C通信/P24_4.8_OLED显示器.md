# 4.8 [I2C]OLED显示器

## 主要内容
本节介绍如何使用 I2C 接口驱动 0.96 寸 OLED 屏幕。该屏幕通常使用 SSD1306 驱动芯片，分辨率为 128x64。

### 硬件连接
*   **VCC**: 接 3.3V (注意电压，部分模块兼容 5V)
*   **GND**: 接地
*   **SCL**: I2C 时钟线 (如 PB8)
*   **SDA**: I2C 数据线 (如 PB9)

---

## 1. OLED显示器的基本原理
*   **自发光**: OLED (Organic Light-Emitting Diode) 是有机发光二极管，不需要背光，每个像素点都能自发光。
*   **驱动芯片 SSD1306**: 内部带有显存 (GDDRAM)。我们只需通过 I2C 将数据写入（==sendbytes==）显存，芯片会自动扫描显示。
*   **显存结构 (128x64)**:
    *   屏幕被分为 **8 个页 (Page 0 ~ Page 7)**。
    *   每一页包含 **128 列 (Column 0 ~ Column 127)**。
    *   每一页的高度是 **8 bit** (即 8 个像素)。
    *   **数据格式**: 写入一个字节，对应一列中的 8 个竖向像素。通常 **低位在上 (LSB Top)**，即 D0 对应最上面的像素，D7 对应最下面的像素。

## 2. 屏幕初始化
OLED 上电后需要进行一系列初始化配置（电荷泵、扫描方向、对比度等）才能正常工作。

```c
void OLED_Init(void)
{
    MyI2C_Init(); // 初始化底层的 GPIO
    
    OLED_WriteCommand(0xAE); // 关闭显示
    OLED_WriteCommand(0xD5); // 设置显示时钟分频比/振荡器频率
    OLED_WriteCommand(0x80);
    OLED_WriteCommand(0xA8); // 设置多路复用率
    OLED_WriteCommand(0x3F);
    OLED_WriteCommand(0xD3); // 设置显示偏移
    OLED_WriteCommand(0x00);
    OLED_WriteCommand(0x40); // 设置显示开始行
    OLED_WriteCommand(0xA1); // 设置左右方向，0xA1正常 0xA0左右反置
    OLED_WriteCommand(0xC8); // 设置上下方向，0xC8正常 0xC0上下反置
    OLED_WriteCommand(0xDA); // 设置COM引脚硬件配置
    OLED_WriteCommand(0x12);
    OLED_WriteCommand(0x81); // 设置对比度控制
    OLED_WriteCommand(0xCF);
    OLED_WriteCommand(0xD9); // 设置预充电周期
    OLED_WriteCommand(0xF1);
    OLED_WriteCommand(0xDB); // 设置VCOMH取消选择级别
    OLED_WriteCommand(0x30);
    OLED_WriteCommand(0xA4); // 设置整个显示打开/关闭
    OLED_WriteCommand(0xA6); // 设置正常/倒转显示
    OLED_WriteCommand(0x8D); // 设置电荷泵
    OLED_WriteCommand(0x14);
    OLED_WriteCommand(0xAF); // 开启显示
    
    OLED_Clear(); // 上电清屏
}
```

## 3. 基本概念和操作

### 写命令 vs 写数据
*   **写命令 (Command)**: 控制 OLED 的行为（如设置光标位置、清屏、初始化）。
*   **写数据 (Data)**: 写入要显示的内容（点阵数据）。

在 I2C 协议中，通常通过控制字节 (Control Byte) 区分：
*   **0x00**: 接下来的字节是命令。
*   **0x40**: 接下来的字节是数据。

```c
void OLED_WriteCommand(uint8_t Command)
{
    MyI2C_Start();
    MyI2C_SendByte(0x78); // 从机地址 (写)
    MyI2C_SendByte(0x00); // 控制字节：命令
    MyI2C_SendByte(Command);
    MyI2C_Stop();
}

void OLED_WriteData(uint8_t Data)
{
    MyI2C_Start();
    MyI2C_SendByte(0x78);
    MyI2C_SendByte(0x40); // 控制字节：数据
    MyI2C_SendByte(Data);
    MyI2C_Stop();
}
```

### 设置光标位置
写入数据前，需要告诉 OLED 从哪里开始写。通常使用**页寻址模式**。
```c
void OLED_SetCursor(uint8_t Y, uint8_t X)
{
    OLED_WriteCommand(0xB0 | Y);                 // 设置页地址 (0~7)
    OLED_WriteCommand(0x10 | ((X & 0xF0) >> 4)); // 设置列地址高4位
    OLED_WriteCommand(0x00 | (X & 0x0F));        // 设置列地址低4位
}
```

### 清屏 (Clear)
遍历所有页和列，写入 0x00。
```c
void OLED_Clear(void)
{
    uint8_t i, j;
    for (i = 0; i < 8; i++)
    {
        OLED_SetCursor(i, 0);
        for (j = 0; j < 128; j++)
        {
            OLED_WriteData(0x00);
        }
    }
}
```

## 4. 文字相关的操作
OLED 本身没有字库，需要我们在代码中定义字模数组 (通常在 `OLED_Font.h`)。
常用的字体大小是 **8x16** (宽8，高16，占2页) 或 **6x8** (宽6，高8，占1页)。

### 显示字符 (ShowChar)
以 8x16 字体为例，显示一个字符需要写入 16 个字节的数据（上半部分 8 字节，下半部分 8 字节）。
```c
// Line: 行 (1~4), Column: 列 (1~16), Char: 字符
void OLED_ShowChar(uint8_t Line, uint8_t Column, char Char)
{
    uint8_t i;
    // 计算字库偏移量 (ASCII码 - 32) * 16
    // OLED_F8x16 是字模数组
    OLED_SetCursor((Line - 1) * 2, (Column - 1) * 8); // 上半部分
    for (i = 0; i < 8; i++)
    {
        OLED_WriteData(OLED_F8x16[Char - ' '][i]);
    }
    OLED_SetCursor((Line - 1) * 2 + 1, (Column - 1) * 8); // 下半部分
    for (i = 0; i < 8; i++)
    {
        OLED_WriteData(OLED_F8x16[Char - ' '][i + 8]);
    }
}
```

### 显示字符串 (ShowString)
循环调用 `OLED_ShowChar`。
```c
void OLED_ShowString(uint8_t Line, uint8_t Column, char *String)
{
    uint8_t i;
    for (i = 0; String[i] != '\0'; i++)
    {
        OLED_ShowChar(Line, Column + i, String[i]);
    }
}
```

### 显示数字
包括十进制、十六进制、二进制等，通常先转换每一位对应的字符，再调用显示字符函数。
*   `OLED_ShowNum(Line, Column, Number, Length)`: 显示十进制无符号数字
*   `OLED_ShowSignedNum(...)`: 显示有符号数字
*   `OLED_ShowHexNum(...)`: 显示十六进制
*   `OLED_ShowBinNum(...)`: 显示二进制

## 5. 绘图相关的操作
由于 SSD1306 在 I2C 模式下通常不支持“读取显存”，因此不能直接在屏幕上打点（需要先读出来，修改一位，再写回去）。
如果要实现任意画点、画线，通常有两种方法：

1.  **显存缓冲 (Frame Buffer)**: 
    *   在 MCU 内存中定义一个 `uint8_t OLED_GRAM[8][128]` 数组。
    *   所有的画点操作都修改这个数组。
    *   最后调用 `OLED_Refresh()` 一次性把数组刷到屏幕上。
    *   优点：功能强大，支持画线、圆等；缺点：占用 MCU 1KB RAM，刷新速度受 I2C 限制。

2.  **直接覆盖 (取模软件)**:
    *   使用取模软件 (如 PCtoLCD2002) 将图片转换成十六进制数组。
    *   直接将数组按顺序写入 OLED。

### 显示图片 (ShowImage)
```c
// 显示一张图片，参数通常是图片的取模数组
void OLED_ShowImage(uint8_t Line, uint8_t Column, uint8_t Width, uint8_t Height, const uint8_t *Image)
{
    uint8_t i, j;
    // 假设 Height 是 8 的倍数，计算需要多少页
    uint8_t PageHeight = Height / 8; 
    
    for (j = 0; j < PageHeight; j++)
    {
        OLED_SetCursor((Line - 1) + j, (Column - 1));
        for (i = 0; i < Width; i++)
        {
            // 按列写入数据
            OLED_WriteData(Image[j * Width + i]);
        }
    }
}
```