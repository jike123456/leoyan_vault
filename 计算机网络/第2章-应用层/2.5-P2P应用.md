# 2.5 P2P 应用 (Peer-to-Peer Applications)

P2P体系结构与传统的客户-服务器（C/S）模型截然不同。它不依赖于一个“永远在线”的中心服务器，而是让大量间歇性连接的主机（称为**对等方，Peer**）直接进行通信和资源共享。

---

### 1. P2P 体系结构的特性

*   **与C/S结构的对比**
    *   **C/S模型**: 想象一下去图书馆借书。所有人都必须去同一个图书馆（服务器），图书馆的藏书量和工作人员数量是有限的，当借书的人（客户）太多时，图书馆就会拥挤不堪，甚至瘫痪。
    *   **P2P模型**: 想象一下一个读书分享会。每个人都带着自己的书来，可以直接相互交换阅读。来的人越多，可供交换的书也越多，整个分享会的资源也就越丰富。

*   **核心特性：自扩展性 (Self-scalability)**
    *   **定义**: 在P2P文件分发中，每个对等方在下载数据的同时，也会向其他对等方上传数据。这意味着，随着新对等方的加入，系统的总服务能力（上传带宽）也随之增加。
    *   **结果**: 系统的性能不会因为用户数量的增加而下降，甚至可能变得更好。这是P2P体系结构最吸引人的优点。

---

### 2. BitTorrent

BitTorrent是目前最流行的P2P文件分发协议之一。

*   **基本概念**:
    *   **洪流 (Torrent)**: 参与一个特定文件分发的所有对等方的集合。
    *   **文件块 (Chunks)**: 文件被分割成许多固定大小（如256KB）的块。对等方之间交换的就是这些块。
    *   **追踪器 (Tracker)**: 一个“协调员”服务器。它不存储文件内容，只负责跟踪参与洪流的对等方，并帮助新加入的对等方找到其他对等方。

*   **工作原理**:
    1.  一个新对等方（如Alice）首先从追踪器获取参与洪流的对等方列表。
    2.  Alice与列表中的某些对等方建立连接。
    3.  Alice开始从这些对等方那里请求文件块。在下载的同时，Alice也向其他对等方提供自己已经下载的块。
    4.  **交换策略**:
        *   **最稀缺优先 (Rarest First)**: Alice会优先请求那些在邻居中副本数量最少的块。这有助于保证所有块都能在洪流中均匀分布。
        *   **一报还一报 (Tit-for-Tat)**: Alice会优先向那些为她提供了最快下载速率的对等方上传数据。这种“投桃报李”的激励机制鼓励用户贡献上传带宽，从而提高了整个系统的性能。

---

### 3. P2P 网络中的搜索

在一个P2P网络中，如何找到你想要的文件或资源？这取决于网络的组织方式。

*   **非结构化P2P网络 (Unstructured P2P Networks)**
    *   **特点**: 对等方之间的连接是随机、任意的，没有预先定义的结构。
    *   **搜索方式：洪泛查询 (Query Flooding)**
        1.  一个对等方想查找文件，它向所有与之直接相连的邻居发送查询请求。
        2.  收到查询的邻居如果自己没有该文件，就继续将查询转发给它们自己的所有邻居（除了发送者）。
        3.  这个过程不断重复，直到找到文件或达到一定的转发跳数限制。
    *   **缺点**: 会产生大量的查询流量，对网络造成巨大负担。

---

### 4. 分布式哈希表 (Distributed Hash Tables, DHT)

为了解决非结构化网络中搜索效率低下的问题，人们设计了结构化的P2P网络，其中最著名的一种实现就是DHT。

*   **核心思想**: 将资源（如文件）的定位责任**分布式**地分配给网络中的所有对等方。
*   **工作原理**:
    1.  **哈希**: 每个对等方被赋予一个唯一的ID，每个文件也被赋予一个唯一的ID（通常是对文件名或内容进行哈希计算得到）。这些ID都在同一个数值空间内。
    2.  **责任分配**: 规定每个ID由一个特定的对等方负责。最简单的规则是：让ID值与对等方ID值最接近的那个对等方来负责。
    3.  **查询**: 当一个对等方想查找某个文件时，它首先计算出该文件的ID，然后通过一个高效的路由协议，直接（或通过少数几跳转发）找到那个负责该ID的对-**结构化P2P网络 (Structured P2P Networks)**: 每个对等方负责存储一小部分内容索引。
*   **环形DHT (Circular DHT)**:
  -   一种简单的DHT实现。所有对等方根据其ID值在一个逻辑环上排序。
  -   每个对等方只需要维护指向其后继者和前任的连接，以及一些指向环上其他对等方的“捷径”连接。
  -   查询请求可以沿着环或者通过“捷径”被高效地路由到负责目标ID的对等方。

通过DHT，P2P网络实现了在无需中心服务器的情况下，对资源进行高效、可扩展的定位。
