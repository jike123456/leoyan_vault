# 2.2 Web 和 HTTP

超文本传输协议（HTTP, HyperText Transfer Protocol）是Web的核心。它是一个应用层协议，规定了Web客户（如浏览器）和Web服务器之间如何请求和传输Web页面（由HTML、CSS、图片、视频等对象组成）。

---

### 1. HTTP 概览

*   **应用模型**: HTTP采用**客户-服务器（C/S）模型**。浏览器作为客户端，向Web服务器发送请求；Web服务器接收请求，处理后返回响应。
*   **作为“拉”协议**: HTTP是一个**拉协议（pull protocol）**。这意味着信息是由客户主动从服务器“拉”过来的。服务器不会主动向客户“推”送信息（注：现代Web技术如WebSocket可以实现推送）。
*   **使用TCP作为运输层协议**: HTTP使用TCP来保证报文的可靠传输。当用户点击一个链接时，浏览器会先与服务器建立一个TCP连接（默认端口为80），然后通过这个连接发送HTTP请求和接收响应。
*   **无状态协议 (Stateless Protocol)**: HTTP的一个重要特点是**无状态**。服务器不会保存关于过去客户端请求的任何信息。每个请求都被视为独立的事务。
    *   **优点**: 简化了服务器的设计，使其能够支持更多的并发用户。
    *   **缺点**: 对于需要记录用户状态的应用（如网上购物、用户登录），需要额外的机制来维持状态。

---

### 2. 连接类型

*   **非持续连接 (Non-Persistent Connection)**
    *   **工作方式**: 每个Web对象（如一个HTML文件、一张图片）的请求/响应都通过一个**独立的、新的TCP连接**来完成。
    *   **流程**:
        1.  建立TCP连接。
        2.  发送HTTP请求。
        3.  接收HTTP响应。
        4.  关闭TCP连接。
        *如果一个页面包含10张图片，那么总共需要建立11个TCP连接（1个HTML + 10个图片）。*
    *   **缺点**: 开销大。每个连接都需要进行三次握手，增加了延迟。

*   **持续连接 (Persistent Connection)**
    *   **工作方式**: 客户端和服务器之间建立一个TCP连接后，后续的多个请求和响应可以**复用**这同一个连接。
    *   **优点**: 显著减少了延迟和服务器的负担。这是现代HTTP（HTTP/1.1及以后版本）的默认行为。
    *   **类型**:
        *   **不带流水线的持续连接**: 客户端必须等待上一个响应到达后，才能发送下一个请求。
        *   **带流水线的持续连接**: 客户端可以像流水线一样，连续发送多个请求，而无需等待响应。

---

### 3. HTTP 报文格式

HTTP报文是服务器和客户端之间交换的数据块，分为请求报文和响应报文两种。

*   **请求报文 (Request Message)**
    *   **请求行 (Request Line)**:
        *   `GET /path/to/file/index.html HTTP/1.1`
        *   包含三个字段：**方法 (Method)**（如GET, POST, HEAD, PUT, DELETE）、**URL** 和 **HTTP版本**。
    *   **首部行 (Header Lines)**:
        *   以`Key: Value`的形式提供关于请求的附加信息。
        *   `Host: www.example.com` (必需)
        *   `User-Agent: Mozilla/5.0 ...` (浏览器类型)
        *   `Accept-Language: en` (希望接收的语言)
    *   **实体主体 (Entity Body)**:
        *   在使用POST方法提交表单或上传文件时使用，GET请求的实体主体为空。

*   **响应报文 (Response Message)**
    *   **状态行 (Status Line)**:
        *   `HTTP/1.1 200 OK`
        *   包含三个字段：**HTTP版本**、**状态码 (Status Code)** 和 **状态信息**。
        *   **常见状态码**:
            *   `200 OK`: 请求成功。
            *   `301 Moved Permanently`: 永久重定向。
            *   `400 Bad Request`: 请求无效。
            *   `404 Not Found`: 服务器上未找到请求的资源。
            *   `505 HTTP Version Not Supported`: 服务器不支持请求的HTTP版本。
    *   **首部行 (Header Lines)**:
        *   `Content-Type: text/html` (响应内容的类型)
        *   `Content-Length: 1234` (响应内容的长度)
        *   `Date: ...` (响应生成的日期)
    *   **实体主体 (Entity Body)**:
        *   包含所请求的资源本身（如HTML文件、图片数据等）。

---

### 4. 用户与服务器的交互：Cookie

为了解决HTTP的无状态问题，引入了Cookie机制。

*   **工作原理**:
    1.  当服务器第一次收到来自某个客户端的请求时，它会在响应报文中添加一个`Set-Cookie:`首部行，其中包含一个唯一的ID。
    2.  客户端浏览器收到响应后，会将这个ID存储在本地的Cookie文件中。
    3.  之后，该客户端向该服务器发送的每个请求，都会附上一个`Cookie:`首部行，其中包含之前收到的ID。
*   **作用**: 服务器通过这个ID就能识别出是哪个用户，从而可以维护该用户的状态，如登录会话、购物车内容等。

---

### 5. Web 缓存 (Web Caching / Proxy Server)

*   **定义**: Web缓存也叫**代理服务器**，它是一个网络实体，代表原始Web服务器来满足HTTP请求。
*   **工作原理**:
    1.  浏览器向Web缓存发送HTTP请求。
    2.  Web缓存检查自己是否存有该对象的副本。
    3.  如果**有**，则直接将副本返回给浏览器。
    4.  如果**没有**，Web缓存会向原始服务器发送请求，获取该对象，存储一份副本后，再返回给浏览器。
*   **优点**:
    *   **减少客户端的响应时间**: 从地理位置更近的缓存获取内容通常更快。
    *   **减少机构网络出口的流量**: 多个客户端请求同一个对象时，只需从原始服务器获取一次。
*   **条件GET方法 (Conditional GET)**: 为了确保缓存的副本不是过时的，缓存可以使用`If-Modified-Since:`请求首部。如果原始服务器上的对象在该日期之后没有被修改过，服务器会返回一个`304 Not Modified`的空响应，告知缓存可以使用其现有副本。
