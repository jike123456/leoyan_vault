# 2.6 视频流和内容分发网(CDN)

视频流是当今互联网流量的最主要组成部分。与传统的文件下载不同，视频流应用对网络的**带宽**和**时延**非常敏感，这给网络带来了巨大的挑战。

---

### 1. 流式视频概述

*   **挑战**:
    *   **高带宽需求**: 高清晰度的视频文件非常巨大。
    *   **连续播放需求**: 用户希望能够流畅地观看视频，不能有长时间的卡顿。
    *   **网络异构性**: 不同的用户拥有不同的网络接入带宽（如光纤、4G、拥挤的WiFi）。

---

### 2. HTTP 经宿流 (Streaming Stored Video over HTTP)

这是最基础的视频流方法。

*   **工作原理**:
    1.  视频文件被存储在一个标准的HTTP服务器上。
    2.  客户端（如浏览器）与服务器建立TCP连接，并发送一个对该视频文件的HTTP GET请求。
    3.  服务器收到请求后，将视频文件数据放入HTTP响应报文中发回给客户端。
    4.  客户端在接收数据的同时，维护一个**客户播放缓存（Client Buffering）**。只有当缓存中的数据达到一定阈值后，才开始播放视频。
*   **优点**: 简单，易于实现，能穿透大多数防火墙（因为使用标准的HTTP协议）。
*   **缺点**: 无法适应客户端网络带宽的变化。如果网络状况变差，缓存会很快耗尽，导致视频播放卡顿。

---

### 3. 经HTTP的动态适应性流 (DASH - Dynamic Adaptive Streaming over HTTP)

DASH是目前主流的视频流技术，被YouTube、Netflix等广泛采用。它旨在解决HTTP经宿流无法适应网络变化的缺点。

*   **核心思想**: **让客户端来决定看什么清晰度的视频**。
*   **工作原理**:
    1.  **视频分块和多码率编码**: 视频内容提供商首先将视频分割成若干个小的**视频块（Chunk）**，每个块通常为几秒钟时长。然后，将每个块用**多种不同的码率（Bit Rate）**进行编码，生成多个不同清晰度（和大小）的版本。
    2.  **清单文件 (Manifest File)**: 服务器提供一个清单文件，其中包含了各个视频块以及它们不同码率版本的URL地址。
    3.  **客户端动态选择**:
        *   客户端首先请求并解析清单文件。
        *   客户端周期性地测量自身可用的网络带宽。
        *   在请求下一个视频块时，客户端会根据当前带宽，**智能地**从清单文件中选择一个最合适的码率版本（即在保证不卡顿的前提下，选择尽可能高的清晰度）。
*   **优点**:
    *   **自适应性**: 能根据网络状况动态调整视频质量，为用户提供流畅的观看体验。
    *   **基于HTTP**: 继承了HTTP协议的所有优点。

---

### 4. 内容分发网 (Content Distribution Network, CDN)

当视频服务需要面向全球大量用户时，如果所有用户都从同一个或少数几个数据中心请求视频，会面临两个主要问题：1) 延迟高；2) 服务器和网络不堪重负。CDN就是为了解决这个问题而生的。

*   **核心思想**: **将内容推到离用户更近的地方**。
*   **工作原理**:
    1.  **分布式缓存**: CDN在全球各地（通常是在ISP的网络中）部署大量的**缓存服务器集群**。
    2.  **内容复制**: 原始的内容（如视频文件）被复制并分发到这些缓存服务器上。
    3.  **请求重定向**: 当一个用户想观看视频时，CDN需要将用户的请求**智能地重定向**到离该用户“最近”且负载较轻的缓存服务器上。
*   **类比**: 就像京东在全国各地建立大量的本地仓库。当你在北京下单时，货物会从北京或周边的仓库发出，而不是从遥远的广东总部发出，从而大大缩短了你的收货时间。
*   **CDN操作 - 如何选择最佳服务器？**:
    *   **DNS重定向**: 这是最常用的方法。当用户查询视频服务器的域名时（如 `video.example.com`），CDN服务商的权威DNS服务器会根据用户的源IP地址，判断其地理位置，并返回一个离用户最近的CDN缓存服务器的IP地址。
*   **优点**:
    *   **降低延迟**: 用户从更近的服务器获取内容。
    *   **提高可用性**: 即使某个服务器集群出现故障，请求也可以被重定向到其他集群。
    *   **扩展性好**: 能够支持海量用户的并发访问。
