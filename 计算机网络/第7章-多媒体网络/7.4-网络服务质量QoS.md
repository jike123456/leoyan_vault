# 7.4 网络服务质量 (Quality of Service, QoS)

标准的互联网提供的是**尽力而为（Best-Effort）**的服务，它不对数据分组的交付做任何保证。然而，多媒体应用对网络性能有严格要求。为了满足这些需求，人们提出了一系列机制来提供**服务质量（QoS）**保证。

---

### 1. 服务质量 (QoS) 的定义

*   **定义**: QoS是网络为某个应用程序的数据流（Flow）提供的一组**可量化的**、**可承诺的**性能保证。
*   **度量指标**:
    *   **可靠性 (Reliability)**: 数据是否能保证100%送达。
    *   **时延 (Delay)**: 分组从源到端的延迟上限。
    *   **抖动 (Jitter)**: 分组端到端延迟的变化范围。
    *   **带宽 (Bandwidth)**: 保证的最小数据传输速率。

---

### 2. 实现 QoS 的机制

要实现端到端的QoS，需要在网络的多个层面引入复杂的机制。

*   **准入控制 (Admission Control)**
    *   **功能**: 在允许一个新的数据流进入网络之前，先判断网络是否有足够的资源（带宽、缓冲区空间等）来满足其QoS要求，同时又不影响现有数据流的服务质量。
    *   **类比**: 就像一个高档餐厅的预约系统。在接受你的预订之前，餐厅会先检查是否有空位，以确保能为你提供高质量的服务，而不会因为顾客太多而导致服务水平下降。如果没位置了，就只能拒绝你的预订。

*   **流量整形 (Traffic Shaping)**
    *   **功能**: 在网络边缘（如发送主机或接入路由器）控制数据流进入网络的速率，将其从不规则的突发流量“整形”为更平滑、更可预测的流量。
    *   **算法**:
        *   **漏桶 (Leaky Bucket)**: 强制数据以一个恒定的平均速率流出，能有效地平滑流量，但无法应对突发流量。
        *   **令牌桶 (Token Bucket)**: 允许在一定程度上累积“令牌”，从而在需要时能够以高于平均速率的速率进行突发传输，灵活性更好。

*   **分组调度 (Packet Scheduling)**
    *   **功能**: 在路由器中，当多个分组在输出队列中争用同一个链路时，调度算法决定**下一个**该发送哪个分组。
    *   **算法**:
        *   **先进先出 (FIFO)**: 最简单，无差别服务，无法提供QoS。
        *   **优先权排队 (Priority Queuing)**: 将分组分为高、低等不同优先级。路由器总是优先发送高优先级队列中的分组。可能导致低优先级分组“饿死”。
        *   **循环排队 (Round Robin)**: 多个队列轮流获得服务机会。
        *   **加权公平排队 (Weighted Fair Queuing, WFQ)**: 循环排队的改进版。它根据不同队列的权重（代表其QoS需求），按比例分配链路带宽，既保证了公平性，又能提供有差别的服务。

---

### 3. QoS 体系结构

要在整个互联网范围内提供QoS，需要一套完整的体系结构。主要有两种思路：

*   **综合服务 (Integrated Services, IntServ)**
    *   **核心思想**: 为**每个数据流**提供**细粒度的、有绝对保证**的QoS。
    *   **工作方式**: 应用程序在发送数据前，需要通过一个信令协议（如 **RSVP - 资源预留协议**）向沿途的所有路由器明确地请求并**预留**其所需的资源（如带宽）。
    *   **类比**: 像**电路交换**。在通话前必须先建立一条专用线路。
    *   **优点**: 能提供非常强的、可量化的服务保证。
    *   **缺点**: **状态管理复杂，扩展性极差**。网络中的核心路由器需要为成千上万个数据流维护预留状态，这在互联网规模上是不可行的。

*   **区分服务 (Differentiated Services, DiffServ)**
    *   **核心思想**: 不再为每个流提供单独保证，而是将所有数据分组划分为少数几个**服务等级**，并为不同等级的分组提供**有差别的、相对的**服务。
    *   **工作方式**:
        1.  在网络边缘，根据数据流的类型（或与服务提供商的约定），将每个IP数据报的头部中的**服务类型（ToS）**字段打上一个标记（称为**DSCP**）。
        2.  网络核心的路由器只根据这个标记，对分组进行相应的调度处理（例如，标记为“高优先级”的分组会被优先转发）。核心路由器无需维护任何每个流的状态。
    *   **类比**: 就像机票的舱位。航空公司不关心每个乘客的具体身份，只根据你的票是“头等舱”、“商务舱”还是“经济舱”，来提供不同等级的服务（优先登机、更好的座位等）。
    *   **优点**: **简单、扩展性好**，是目前互联网中实现QoS更为主流和现实的方法。
    *   **缺点**: 只能提供相对的服务保证（“金牌服务”优于“银牌服务”），而不能提供绝对的、可量化的保证。
