# 7.3 实时传输协议 (RTP)

实时传输协议（RTP）是为互联网上承载实时音视频流量而设计的标准协议。它本身**不解决**所有实时通信的问题，而是为应用程序提供了一个解决这些问题的**标准框架**。

---

### 1. RTP 的角色和定位

*   **定位**: RTP被定义为一个**应用层协议**，但它的功能更像是运输层协议的增强。它通常运行在**UDP之上**，以利用UDP的低延迟和应用层控制特性。
*   **核心作用**: RTP为应用程序提供了一些在UDP之上进行实时多媒体传输所必需的关键功能，而这些功能是UDP本身不提供的。
*   **不提供什么**:
    *   **不保证QoS**: RTP不提供任何带宽、延迟或可靠性的保证。
    *   **不保证可靠交付**: 它不进行确认或重传。
*   **类比**: 如果把UDP看作是一个只负责快速运送的“裸奔”快递服务，那么RTP就像是为这个快递服务增加了一套标准的“运单系统”。运单本身不能保证包裹不丢，但它提供了包裹的编号、打包时间、内容类型等关键信息，使得收件人（应用程序）可以更好地处理收到的包裹。

---

### 2. RTP 的功能

RTP通过在其首部中加入几个关键字段，为应用程序提供了以下重要功能：

*   **载荷类型标识 (Payload Type Identification)**
    *   **功能**: RTP首部中的“载荷类型”字段用于指示该分组中承载的是哪种类型的媒体编码（例如，是PCM编码的音频，还是H.264编码的视频）。
    *   **意义**: 使得接收方能够用正确的解码器来处理数据。它还允许在同一次会话中动态地改变编码方式。

*   **序号 (Sequence Number)**
    *   **功能**: RTP为每个发送的分组分配一个递增的序号。
    *   **意义**:
        1.  **检测丢包**: 接收方可以通过检查收到的序号是否连续，来判断是否有分组在传输中丢失。
        2.  **恢复时序**: 网络可能会导致分组乱序到达。接收方可以根据序号，将乱序的分组重新排列成正确的播放顺序。

*   **时间戳 (Timestamp)**
    *   **功能**: RTP首部中的时间戳反映了该分组中第一个样本的**采样时刻**。
    *   **意义**:
        1.  **同步**: 对于视频和音频，需要确保声音和画面同步播放（唇音同步）。时间戳提供了实现这种同步的依据。
        2.  **计算抖动**: 接收方通过分析到达的分组的时间戳和实际到达时间的差异，可以计算出网络抖动的大小，从而动态地调整其播放缓存。

---

### 3. RTP 报文格式

一个RTP报文由**RTP首部**和**载荷数据**（如一个音频或视频块）组成。整个RTP报文随后被封装在一个UDP报文段中。

*   **RTP首部 (12字节)**: 包含了版本号、载荷类型、序号、时间戳以及同步源标识（SSRC）等字段。

---

### 4. RTCP (Real-time Transport Control Protocol)

RTCP是RTP的伴侣协议，它与RTP协同工作，负责**带外（out-of-band）**的控制和监控。

*   **功能**:
    *   **质量反馈**: 接收方会周期性地向发送方发送RTCP报告，其中包含了关于接收质量的统计信息，如已接收的分组数、丢包率、网络抖动等。
    *   **会话控制**: 发送方可以根据这些反馈信息，动态地调整其发送行为（例如，在网络状况不佳时降低视频编码的码率）。
    *   **同步**: RTCP报文中的时间戳信息可以用于同步不同的媒体流（如音频和视频）。
*   **工作方式**: RTCP报文与RTP数据报文在不同的端口上传输，独立于RTP数据流。
