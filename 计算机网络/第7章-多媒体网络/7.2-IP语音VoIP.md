# 7.2 IP语音 (Voice-over-IP, VoIP)

IP语音（VoIP）是将传统的电话语音通话，通过互联网（IP网络）来进行的技术。它彻底改变了电信行业，是交互式实时多媒体应用的最典型代表。

---

### 1. VoIP 的特点

VoIP的核心过程包括：
1.  **数字化**: 将人说话时产生的模拟声波，通过采样和量化，转换成数字数据。
2.  **压缩**: 对数字数据进行压缩，以减少传输所需的带宽。
3.  **封装**: 将压缩后的数据块封装在一个IP分组中（通常使用UDP）。
4.  **传输**: 通过IP网络将分组发送给对方。
5.  **解封装、解压、播放**: 接收方执行相反的过程，将声音播放出来。

---

### 2. 对网络的要求与挑战

为了保证通话的自然流畅，VoIP对网络性能提出了非常苛刻的要求。

*   **端到端时延 (End-to-End Delay)**
    *   **要求**: 人类对话的经验表明，如果延迟超过400毫秒，对话会变得困难。因此，VoIP的端到端延迟通常要求控制在 **150毫秒** 以内，以提供良好的通话体验。
    *   **延迟来源**: 包括发送端的处理延迟、网络中的传播和排队延迟、以及接收端的播放延迟。

*   **时延抖动 (Jitter)**
    *   **现象**: 由于网络拥塞是动态变化的，每个语音分组在网络中经历的延迟都不同，导致它们到达接收端的时间间隔不均匀。
    *   **解决方案**: **播放缓存 (Playout Buffer)**。接收端会将收到的语音分组先放入一个缓存区，然后以一个固定的、平滑的速率取出并播放。
    *   **权衡**: 缓存区越大，抵抗抖动的能力越强，但引入的延迟也越大。因此，播放缓存的大小需要动态调整，在平滑抖动和控制延迟之间取得平衡。

*   **分组丢失 (Packet Loss)**
    *   **影响**: VoIP通常运行在UDP之上，所以分组丢失是可能发生的。一个丢失的分组会导致一小段语音信息的缺失。
    *   **补偿策略**:
        1.  **前向纠错 (Forward Error Correction, FEC)**: 发送方在发送数据时，加入一些冗余信息。例如，将第n个分组和第n-1个分组的内容进行异或（XOR）运算，生成一个冗余分组。如果第n个分组丢失了，但接收方收到了n-1和冗余分组，就可以通过解码恢复出第n个分组。这种方法增加了带宽消耗。
        2.  **交织 (Interleaving)**: 将多个语音块的数据打乱顺序进行混合，然后再打包发送。这样，即使一个分组丢失，它所造成的影响也被分散到多个语音块中，听起来可能只是一个短暂的、可接受的噪声，而不是一段明显的静音。这种方法增加了延迟。
        3.  **基于接收方的修复**: 如果检测到丢包，接收方可以尝试通过插值等方法，根据丢失分组前后的语音信息来“猜测”并生成一段替代的音频。

---

### 3. 信令协议 (Signaling Protocols)

在实际通话开始之前，双方需要进行一系列的“协商”，例如告诉网络“我想和某人通话”、“对方是否在线”、“对方是否接受通话”等。这个过程由**信令协议**来完成。

*   **SIP (Session Initiation Protocol) - 会话发起协议**
    *   **角色**: SIP是目前VoIP领域最主流的应用层信令协议。它负责**建立、管理和终止**IP网络中的呼叫会话。
    *   **特点**:
        *   **轻量级**: SIP的报文格式和语法与HTTP非常相似，是基于文本的，易于理解和扩展。
        *   **与媒体无关**: SIP只负责会话的控制（“打电话”、“挂电话”），不关心实际传输的媒体内容是什么（可以是语音、视频或其他数据）。实际的媒体流通常由RTP协议来承载。
    *   **工作方式**: 用户通过SIP向一个**SIP代理服务器（或注册器）**进行注册。当用户想发起呼叫时，它向代理服务器发送一个SIP `INVITE` 请求，代理服务器负责找到被叫方并转发请求，从而建立起双方的通话。
