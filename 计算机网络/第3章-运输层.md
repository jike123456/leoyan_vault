# 第3章 运输层 (Transport Layer)

运输层在网络协议栈中扮演着承上启下的关键角色。它为运行在不同主机上的**应用进程**之间提供**逻辑通信（Logical Communication）**。本章将深入探讨因特网中两个核心的运输层协议：提供“尽力而为”服务的UDP，以及提供可靠数据传输服务的TCP。

## 核心内容

### 1. 运输层服务介绍
*   **运输层 vs. 网络层**:
    *   **网络层**（如IP协议）提供的是**主机之间**的逻辑通信。它负责将数据从一台主机送到另一台主机，但它不关心数据具体交给哪一个应用程序。
    *   **运输层**则在网络层的基础上，将通信的粒度细化到**进程之间**。它确保从发送方应用程序发出的数据，能够准确地交付给接收方的正确应用程序。
*   **类比**: 想象两栋大楼（主机），公司A的CEO（进程A）要给公司B的CEO（进程B）寄一封信。
    *   **网络层**就像邮政系统，负责把信件从A大楼送到B大楼。
    *   **运输层**就像两栋大楼的内部收发室，负责确保信件从A公司的CEO办公室，准确地送到B公司的CEO办公室，而不是送到B公司的前台或保洁部。

### 2. 多路复用与多路分解 (Multiplexing and Demultiplexing)
这是运输层实现“进程到进程”通信的核心机制。
*   **多路分解**: 在接收端，运输层检查收到的数据报文段（Segment）的**端口号**，并根据端口号将数据准确地分发给绑定在该端口上的应用程序进程（Socket）。
*   **多路复用**: 在发送端，运输层从多个应用程序（通过不同的端口）收集数据，为它们封装上运输层头部（包含源和目的端口号），然后将这些报文段交给网络层。
*   **类比**: 端口号就像大楼里的房间号。运输层根据房间号来派送和揽收信件。

### 3. 无连接运输：UDP (User Datagram Protocol)
UDP提供了一种非常基础的、“ bare-bones ”的运输服务。
*   **特点**:
    *   **无连接**: 发送数据前无需握手。
    *   **不可靠**: 不保证数据能到达，也不保证顺序。
    *   **简单快速**: 开销极小，几乎只是在IP协议上加了端口号和差错校验功能。
*   **适用场景**: DNS、流媒体、在线游戏等能容忍少量丢包但对实时性要求高的应用。

### 4. 可靠数据传输原理 (Principles of Reliable Data Transfer)
这是本章的理论核心。我们将从零开始，逐步构建一个可靠数据传输协议，理解其中的关键技术：
*   **差错检测**: 通过校验和等方式发现数据在传输中是否出错。
*   **确认 (ACK)**: 接收方向发送方回复确认报文，表示已正确收到数据。
*   **超时重传**: 发送方在发送数据后启动一个计时器，如果在规定时间内没有收到确认，就重新发送该数据。
*   **流水线技术**: 为了提高效率，允许发送方连续发送多个分组，而无需等待前一个的确认。这引出了两种经典的协议：
    *   **回退N步 (Go-Back-N, GBN)**: 简单但效率稍低。
    *   **选择重传 (Selective Repeat, SR)**: 更复杂但效率更高。

### 5. 有连接运输：TCP (Transmission Control Protocol)
TCP将上一节讨论的可靠数据传输原理付诸实践，并增加了连接管理和流量控制功能。
*   **TCP连接**:
    *   **三次握手**: 在通信前，通过三次报文交换来建立连接，确保双方都准备好通信。
    *   **四次挥手**: 通信结束后，通过四次报文交换来优雅地关闭连接。
*   **可靠传输**: TCP使用**序号**和**确认号**来保证所有数据按顺序、无差错、不重复地交付。
*   **流量控制 (Flow Control)**: 接收方通过在TCP报文中告知其**接收窗口（Receive Window）**的大小，来防止发送方发送速度过快，导致接收方缓存溢出。这是一种接收端对发送端的“限速”机制。

### 6. TCP拥塞控制 (Congestion Control)
这是TCP最精妙和复杂的部分，旨在防止整个网络因流量过大而崩溃。
*   **与流量控制的区别**: 流量控制是点对点（接收端对发送端）的，而拥塞控制是端系统对整个网络状态的感知和响应。
*   **核心思想**: 每个TCP发送方根据自己感知到的网络拥塞状况，来动态调整其发送速率。
*   **拥塞判断**: 主要通过**丢包**事件（无论是超时还是收到重复的ACK）来推断网络发生了拥塞。
*   **拥塞控制算法**:
    *   **慢启动 (Slow Start)**: 连接开始时，以指数方式快速增加发送速率。
    *   **拥塞避免 (Congestion Avoidance)**: 当速率达到一定阈值后，转为线性增长，以更温和的方式探测可用带宽。
    *   **快速重传与快速恢复**: 在检测到丢包后，迅速减半发送速率，并进入恢复阶段，而不是完全从慢启动开始，以更快地恢复传输效率。

本章深入探讨了数据如何在端到端之间实现可靠或不可靠的传输，以及TCP如何通过流量控制和拥塞控制来保证网络的稳定性和公平性，是理解网络性能和可靠性的关键。
