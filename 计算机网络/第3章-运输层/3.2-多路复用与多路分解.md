# 3.2 多路复用与多路分解 (Multiplexing and Demultiplexing)

多路复用和多路分解是运输层实现“进程到进程”通信的核心机制。它解决了“如何将来自网络的数据准确地交付给主机上众多应用程序中的某一个”的问题。

---

### 1. 基本概念

*   **多路分解 (Demultiplexing)**
    *   **定义**: 在**接收端**，运输层检查收到的报文段（Segment），并根据其头部信息（主要是端口号），将报文段的数据部分定向到正确的应用程序套接字（Socket）。
    *   **类比**: 想象一栋公寓楼的收发室。邮递员送来一大包信件。收发室的管理员（运输层）会查看每封信上的**房间号（目的端口号）**，然后将信件准确地投递到对应的住户信箱（应用程序套接字）里。这个“分发”信件的过程就是多路分解。

*   **多路复用 (Multiplexing)**
    *   **定义**: 在**发送端**，运输层从主机上的多个不同应用程序套接字收集数据块，为每个数据块封装上运输层头部信息（包含源端口号和目的端口号），从而生成报文段，然后将这些报文段传递给网络层。
    *   **类比**: 公寓楼里的许多住户（应用程序）都想寄信。他们把各自的信件都交给收发室的管理员（运输层）。管理员为每封信贴上邮票，并写好发件人和收件人的地址信息（封装头部），然后把所有信件汇总到一个大邮袋里，交给邮递员（网络层）去统一运送。这个“收集和打包”的过程就是多路复用。

---

### 2. 工作原理

运输层通过**套接字（Socket）**和**端口号（Port Number）**来实现这一过程。

*   **套接字**: 应用程序的“门”，用于收发数据。
*   **端口号**: 16比特的数字（0-65535），用于标识主机上的一个特定应用程序进程。就像公寓楼里的房间号。

当一个报文段到达主机时，运输层会检查报文段中的以下字段来决定将数据交给哪个套接字：
1.  **源IP地址**
2.  **目的IP地址**
3.  **源端口号**
4.  **目的端口号**

---

### 3. 无连接的多路复用与多路分解 (UDP)

由于UDP是无连接的，它对套接字的标识相对简单。

*   **UDP套接字**: 由一个**二元组**唯一标识：`（目的IP地址, 目的端口号）`。
*   **工作方式**:
    *   当一个UDP报文段到达时，接收主机的运输层只检查报文段中的**目的端口号**。
    *   然后将该报文段的数据部分直接交付给绑定在该端口号上的套接字。
    *   如果来自不同源IP或源端口的两个UDP报文段，只要它们的目的端口号相同，它们就会被定向到**同一个套接字**。
*   **类比**: 收发室管理员只看信封上的房间号，不管这封信是从哪里寄来的，只要房间号是“808”，就都扔进“808”的信箱。

---

### 4. 面向连接的多路复用与多路分解 (TCP)

由于TCP是面向连接的，它的套接字标识和处理方式更为复杂。

*   **TCP套接字**: 由一个**四元组**唯一标识：`（源IP地址, 源端口号, 目的IP地址, 目的端口号）`。
*   **工作方式**:
    *   **欢迎套接字 (Welcome Socket)**: TCP服务器首先创建一个“欢迎套接字”，它在一个熟知的端口（如Web服务器的80端口）上监听新的连接请求。
    *   **连接建立**: 当一个客户端向服务器发起连接请求时，服务器的操作系统会为这个特定的客户端连接创建一个**新的“连接套接字（Connection Socket）”**。
    *   **分发**:
        *   当一个TCP报文段到达时，接收主机会检查其**全部四个字段**（源IP、源端口、目的IP、目的端口）。
        *   只有当这四个字段**完全匹配**某个已建立的连接套接字时，报文段才会被交付给该套接字。
*   **结果**:
    *   来自不同客户端（即使它们访问的是同一个目的端口）的TCP连接，会被定向到**不同的连接套接字**。
    *   这使得一个Web服务器（监听80端口）能够同时与成千上万个不同的客户端进行并发通信，并且每个通信会话都是独立和隔离的。
*   **类比**: 公司的总机电话（欢迎套接字，监听一个总机号码）。当客户A打来电话，总机会为他转接到一个专门的客服分机（连接套接字A）上。当客户B打来电话，总机会为他转接到另一个客服分机（连接套接字B）上。总机本身可以继续接听新的电话，而每个客户都在和自己的专属客服进行沟通。
