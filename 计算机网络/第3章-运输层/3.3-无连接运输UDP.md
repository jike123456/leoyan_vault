# 3.3 无连接运输：UDP (User Datagram Protocol)

UDP是一种极其简单的运输层协议。它所提供的服务，基本上只是在IP协议的“主机到主机”交付服务之上，增加了“进程到进程”的交付（通过端口号）和一点差错检测功能。

---

### 1. UDP 的特点与优势

*   **“尽力而为” (Best-effort) 服务**: UDP尽其所能地尝试交付报文，但它**不保证**报文一定能到达目的地。
*   **无连接 (Connectionless)**: 在发送数据之前，UDP的发送方和接收方之间**不需要进行任何形式的握手或预备通信**。每个UDP报文段都是独立地在网络中传输的。
*   **不可靠 (Unreliable)**:
    *   **不保证交付**: 报文段可能会在网络中丢失。
    *   **不保证有序**: 先发送的报文段不一定先到达，可能会乱序。

*   **为什么需要UDP？—— UDP的优点**
    *   **更精细的应用层控制**: UDP将数据原封不动地交给应用程序，何时发送、以什么速率发送，完全由应用程序控制。
    *   **无需建立连接**: 省去了TCP三次握手的延迟，这对于某些需要快速响应的应用（如DNS查询）非常重要。
    *   **无连接状态**: 协议本身非常简单，操作系统无需维护复杂的连接状态信息（如接收和发送缓存、序号等），因此能支持更多的并发客户。
    *   **头部开销小**: UDP的头部只有8个字节，而TCP的头部至少有20个字节，开销更小。

*   **类比**: UDP就像寄**普通平信**。
    *   你不需要先给收信人打电话确认他是否在家（无连接）。
    *   你把信直接扔进邮筒就行了，简单快捷（开销小）。
    *   这封信可能会在路上寄丢，也可能比后寄的信晚到（不可靠、无序）。
    *   邮局不会因为信件太多而让你等一等再寄（无拥塞控制）。

---

### 2. UDP 报文段结构

UDP报文段由一个8字节的头部和后面的数据（来自应用层）组成。

```
 0      7 8     15 16    23 24    31
+--------+--------+--------+--------+
|     源端口号    |    目的端口号   |
+--------+--------+--------+--------+
|      长度      |      校验和     |
+--------+--------+--------+--------+
|                                 |
|            应用数据              |
|                                 |
+---------------------------------+
```

*   **源端口号 (Source Port)**: 发送方进程的端口号。
*   **目的端口号 (Destination Port)**: 接收方进程的端口号。这是实现多路分解的关键。
*   **长度 (Length)**: UDP报文段的总长度（头部+数据），以字节为单位。
*   **校验和 (Checksum)**: 用于检查报文段在传输过程中是否出现了**比特差错**。这是一个可选字段。

---

### 3. UDP 校验和 (Checksum)

*   **目的**: 提供非常基础的**差错检测**功能。它能发现报文段在传输中是否被“损坏”（即某些比特位发生了翻转），但**不能修复**错误。如果检测到错误，接收方通常会直接丢弃该报文段。

*   **计算方法**:
    1.  发送方将报文段中的所有16比特字（包括一个由IP地址等信息组成的“伪首部”、UDP头部和数据）相加。
    2.  如果相加过程中产生了溢出，则将溢出位加到结果的最低位（这称为“反码算术”）。
    3.  对最终的和按位取反，得到的结果就是校验和。
    4.  接收方收到报文段后，用同样的方法对所有16比特字（包括校验和本身）求和。如果结果的所有比特位都是1，则说明没有检测到差错；否则，就认为报文段在传输中发生了错误。

*   **为什么需要校验和？**: 既然IP层和链路层都可能提供差错检测，为什么UDP还需要自己的校验和？
    *   **端到端原则**: 差错可能发生在任何一个环节，包括在路由器的内存中。只有在端到端的运输层进行校验，才能最大程度地保证数据的完整性，确保数据从发送进程到接收进程的途中没有被损坏。
