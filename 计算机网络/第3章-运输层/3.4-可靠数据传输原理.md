# 3.4 可靠数据传输原理 (Principles of Reliable Data Transfer)

可靠数据传输是计算机网络中一个至关重要的问题。其目标是，在底层信道本身是**不可靠**的（可能产生比特差错、丢失分组、延迟分组）情况下，通过协议设计，为上层应用提供一个**可靠**的通信信道。本节通过一个循序渐进的方式，来探讨如何构建一个可靠数据传输协议 (rdt)。

---

### 1. 构建可靠数据传输协议

我们将逐步增加底层信道的复杂性，并相应地增强我们的协议。

*   **rdt1.0: 经完全可靠信道的可靠数据传输**
    *   **假设**: 底层信道是完全可靠的。
    *   **实现**: 非常简单。发送方只需从上层接收数据，打包后发送到信道；接收方只需从信道接收分组，解包后交给上层。
    *   **现实**: 这种情况在现实中不存在，只是一个理想化的起点。

*   **rdt2.0: 经具有比特差错信道的可靠数据传输**
    *   **假设**: 底层信道可能产生比特差错，但分组不会丢失。
    *   **引入机制 (ARQ - 自动重传请求协议)**:
        1.  **差错检测**: 发送方添加校验和，接收方通过校验和检测分组是否损坏。
        2.  **确认 (ACK)**: 接收方收到**完好**的分组后，向发送方发送一个“确认”报文。
        3.  **否认 (NAK)**: 接收方收到**损坏**的分组后，向发送方发送一个“否认”报文。
        4.  **重传**: 发送方收到NAK后，**重传**上一个分组。
    *   **缺陷**: 如果ACK或NAK报文本身损坏了怎么办？发送方无法判断是确认还是否认。
    *   **改进 (rdt2.1, rdt2.2)**: 引入**序号 (Sequence Number)**。发送方为每个分组编号（0, 1, 0, 1...），接收方通过序号来判断收到的分组是否是重复的。当收到损坏的ACK/NAK时，发送方只需重传当前分组即可。接收方可以通过检查序号来丢弃重复的分组。

*   **rdt3.0: 经具有比特差错和丢包的信道**
    *   **假设**: 底层信道既可能产生比特差错，也可能**丢失分组**（包括数据分组和ACK/NAK分组）。
    *   **问题**: 如果一个数据分组或其对应的ACK丢失了，发送方将永远等待下去。
    *   **引入机制**:
        1.  **倒计时定时器 (Countdown Timer)**: 发送方在发送每个分组时，都启动一个定时器。
        2.  **超时重传**:
            *   如果在定时器超时之前收到了ACK，则关闭定时器。
            *   如果定时器超时，发送方就认为该分组（或其ACK）已经丢失，并**自动重传**该分组，然后重启定时器。
    *   **rdt3.0** 是一个功能正确的可靠数据传输协议，但其性能非常低下，因为它是一个**停等协议 (Stop-and-Wait)**，即发送方必须等待一个分组被确认后，才能发送下一个。

---

### 2. 流水线可靠数据传输协议 (Pipelined Protocols)

为了解决停等协议效率低下的问题，我们允许发送方在收到确认之前，连续发送多个分组，就像工厂的流水线一样。这大大提高了信道的利用率。实现流水线协议需要：
*   增加分组的序号范围。
*   发送方和接收方需要缓存多个分组。

主要有两种经典的流水线协议：

*   **回退N步 (Go-Back-N, GBN)**
    *   **发送方**: 维护一个大小为N的**发送窗口**，窗口内的分组可以连续发送出去。
    *   **接收方**: 只维护一个期望接收的序号。它**只按序接收**分组。
        *   如果收到了期望序号的分组，它就发送一个对应该序号的ACK，并将数据交给上层。
        *   如果收到了一个失序的分组（序号大于期望值），它会**直接丢弃**该分组，并重新发送最近一次按序接收的分组的ACK。
    *   **工作方式**: 当发送方收到一个序号为n的ACK时，它知道n以及n之前的所有分组都已被正确接收。如果发生超时，发送方会**重传所有已发送但未被确认的分组**。
    *   **类比**: 老师在黑板上写了1到10号公式。学生看到第5号公式写错了，他会告诉老师：“老师，第5号错了”。老师会擦掉从第5号开始的所有公式（5, 6, 7...），然后从第5号开始重新写一遍。
    *   **优点**: 接收方逻辑简单。
    *   **缺点**: 当网络丢包率高时，会造成大量不必要的重传，效率低下。

*   **选择重传 (Selective Repeat, SR)**
    *   **发送方**: 同样维护一个发送窗口。
    *   **接收方**: 也维护一个大小为N的**接收窗口**。它可以**缓存并确认失序到达的分组**。
    *   **工作方式**:
        *   接收方会对每个正确接收的分组（无论是否按序）都发送一个单独的ACK。
        *   发送方只重传那些**未收到ACK**的分组。当定时器超时时，只重传那一个超时的分组。
        *   接收方将失序的分组缓存起来，直到它收到了所有期望的、连续的分组，然后一次性将一个有序的序列交付给上层。
    *   **类比**: 老师在黑板上写了1到10号公式。学生看到第5号公式写错了，他会告诉老师：“老师，只有第5号错了”。老师只需要擦掉并重写第5号公式即可，其他正确的公式（如6, 7, 8...）学生已经记下来了。
    *   **优点**: 避免了不必要的重传，效率更高。
    *   **缺点**: 协议实现比GBN更复杂。
    
TCP的可靠数据传输机制可以看作是GBN和SR的一种混合体。
