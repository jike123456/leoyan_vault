# 3.6 TCP 拥塞控制 (TCP Congestion Control)

TCP拥塞控制是互联网能够稳定运行至今的关键机制之一。它是一种**利他主义**的行为，旨在防止任何一个TCP连接因为发送速度过快而压垮整个网络，从而损害所有人的利益。

**流量控制 vs. 拥塞控制**:
*   **流量控制 (Flow Control)**: 解决的是**点对点**的问题，防止发送方“淹没”接收方。是一个速度匹配问题。
*   **拥塞控制 (Congestion Control)**: 解决的是**整个网络**的问题，防止发送方“淹没”网络中的路由器。是一个全局资源管理问题。

---

### 1. 拥塞的原因与代价

*   **原因**: 当网络中某个路由器或链路接收数据的速率持续大于其转发数据的速率时，就会发生拥塞。
*   **代价**:
    1.  **排队时延增加**: 路由器的队列变长，导致分组延迟显著增加。
    2.  **分组丢失**: 路由器队列溢出，导致必须丢弃后来的分组。这会引发上层的重传，进一步加剧网络负载。
    3.  **非必要重传**: 过早的超时或错误的拥塞判断可能导致不必要的重传，浪费网络资源。

---

### 2. TCP 拥塞控制的方法

TCP采用的是一种**端到端**的拥塞控制方法。它不依赖于网络设备（路由器）的任何显式反馈，而是让发送方根据自己观测到的网络状况（如丢包和延迟）来**推断**网络是否拥塞，并相应地调整自己的发送速率。

*   **拥塞窗口 (Congestion Window, `cwnd`)**: 发送方维护一个名为“拥塞窗口”的状态变量。它限制了发送方在收到确认之前可以向网络中发送的数据量。
*   **发送速率控制**: 任何时刻，一个TCP发送方已发送但未被确认的数据量不能超过 `min(cwnd, rwnd)`，其中 `rwnd` 是接收方通告的**接收窗口**（用于流量控制）。因此，TCP的实际发送速率大约是 `cwnd / RTT`。

TCP拥塞控制的本质就是一套**动态调整`cwnd`大小的算法**。

---

### 3. TCP 拥塞控制算法 (AIMD)

TCP拥塞控制算法通常被称为**加性增、乘性减 (Additive-Increase, Multiplicative-Decrease, AIMD)**。

*   **核心思想**: 谨慎地探测可用带宽，当发现拥塞时迅速“退缩”。
    *   **加性增**: 在未检测到拥塞时，缓慢地、线性地增加拥塞窗口（每个RTT增加1个MSS）。
    *   **乘性减**: 在检测到拥塞时，将拥塞窗口削减一半。

这个算法主要通过三个阶段来实现：**慢启动**、**拥塞避免**和**快速恢复**。

*   **慢启动 (Slow Start)**
    *   **目标**: 在连接刚建立时，快速地找到网络的可用带宽容量。
    *   **工作方式**: `cwnd`的初始值通常很小（如1个MSS - 最大报文段长）。每当收到一个ACK，`cwnd`就增加1个MSS。这使得`cwnd`**大约每经过一个RTT就翻一番**，呈现**指数增长**。
    *   **结束条件**:
        1.  当`cwnd`增长到一个预设的**慢启动阈值 (`ssthresh`)** 时，结束慢启动，进入拥塞避免阶段。
        2.  如果在此期间检测到丢包，则进入快速恢复阶段。

*   **拥塞避免 (Congestion Avoidance)**
    *   **目标**: 在接近网络容量时，以更温和的方式探测可用带宽，避免引起拥塞。
    *   **工作方式**: `cwnd`不再指数增长，而是**线性增长**，即大约每个RTT只增加1个MSS。

*   **快速重传与快速恢复 (Fast Retransmit and Fast Recovery)**
    *   **问题**: 如果完全依赖超时来判断丢包，网络的反应会很慢。
    *   **快速重传**: 当发送方连续收到**三个冗余的ACK**（即总共4个相同的ACK）时，它就认为这个ACK所确认的下一个报文段已经丢失，并**立即重传该分组**，而无需等待定时器超时。
    *   **快速恢复 (TCP Reno)**:
        1.  当触发快速重传时，TCP认为这只是一个轻微的拥塞信号（因为后续的分组还能到达）。
        2.  它将`ssthresh`设置为当前`cwnd`的一半，并将`cwnd`也设置为该值（而不是像超时事件那样直接降为1）。
        3.  然后进入拥塞避免阶段，开始线性增长。
        *这避免了在轻微丢包时过于激进地降低发送速率，从而提高了性能。*

**总结TCP拥塞控制状态机**:
*   初始状态：`cwnd=1`, `ssthresh`为一个较大值，进入**慢启动**。
*   慢启动阶段：`cwnd`指数增长，直到`cwnd >= ssthresh`，进入**拥塞避免**。
*   拥塞避免阶段：`cwnd`线性增长。
*   **当发生丢包时**:
    *   **如果是超时事件 (Timeout)**: `ssthresh`设为当前`cwnd`的一半，`cwnd`重置为1，重新进入**慢启动**。（这是对严重拥塞的反应）
    *   **如果是收到3个冗余ACK**: 触发**快速恢复**，`ssthresh`和`cwnd`都设为当前`cwnd`的一半，然后直接进入**拥塞避免**。（这是对轻微拥塞的反应）

---

### 4. 公平性

TCP拥塞控制机制天然地倾向于在多个竞争同一瓶颈链路的TCP连接之间**公平地**共享带宽。如果一个连接试图占用比其他连接更多的带宽，它将更快地经历丢包，从而被迫降低其拥塞窗口，最终使得各个连接的速率趋于收敛。
