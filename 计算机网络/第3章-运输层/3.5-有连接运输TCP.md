# 3.5 有连接运输：TCP (Transmission Control Protocol)

TCP是因特网运输层的“主力军”，它在IP协议提供的不可靠服务之上，建立了一个强大的、可靠的、面向连接的数据传输服务。

---

### 1. TCP 的特点

*   **面向连接 (Connection-Oriented)**: 在数据交换开始之前，必须先通过“三次握手”在发送方和接收方之间建立一个逻辑连接。
*   **点对点 (Point-to-Point)**: 一个TCP连接只能在两个端点之间进行。
*   **可靠的、按序的字节流 (Reliable, In-order Byte Stream)**:
    *   **可靠**: TCP保证所有发送的数据最终都能到达接收方。
    *   **按序**: 数据到达的顺序与发送的顺序完全一致。
    *   **字节流**: 应用程序将数据看作是一连串无边界的字节，TCP负责将这些字节分块打包成报文段进行传输。
*   **流水线式 (Pipelined)**: TCP使用滑动窗口协议，允许发送方连续发送多个报文段而无需等待确认，以提高效率。
*   **全双工数据 (Full-Duplex Data)**: 连接双方可以同时进行数据的发送和接收。
*   **流量控制 (Flow Control)**: 防止发送方发送速度过快，压垮接收方。
*   **拥塞控制 (Congestion Control)**: 防止发送方发送速度过快，压垮整个网络。

---

### 2. TCP 报文段结构

TCP报文段由**首部 (Header)** 和**数据 (Data)** 组成。其首部通常为20字节。

*   **源端口号** 和 **目的端口号**: 用于实现多路复用/分解。
*   **序号 (Sequence Number)**:
    *   这是TCP实现可靠性的基石。TCP将数据看作一个字节流，序号是该报文段**数据部分第一个字节**在整个字节流中的编号。
    *   例如，如果一个报文段包含字节1001到1100，则其序号为1001。
*   **确认号 (Acknowledgment Number)**:
    *   表示期望从对方接收的**下一个字节**的序号。
    *   例如，如果A收到了来自B的序号为1001、长度为100字节的报文段，那么A会回复一个确认号为1101的报文，表示“我已经收到了1101之前的所有字节，请从1101开始发送”。这种方式称为**累积确认**。
*   **首部长度**: 指示TCP首部的长度。
*   **标志位 (Flags)**:
    *   `ACK`: 表示确认号字段有效。
    *   `SYN`: 用于发起连接请求。
    *   `FIN`: 用于请求关闭连接。
    *   `RST`: 用于重置连接。
    *   `PSH`: 指示接收方应尽快将数据交给上层应用。
*   **接收窗口 (Receive Window)**: 用于流量控制。该字段告诉对方，自己还有多少可用的缓存空间。

---

### 3. TCP 连接管理

*   **建立连接：三次握手 (Three-way Handshake)**
    *   **类比**: A给B打电话。
    1.  **SYN**: A拨通B的电话，说：“你好，我是A，你能听到我吗？” (客户端发送一个SYN=1, seq=x的报文)
    2.  **SYN/ACK**: B听到后，回答：“我能听到。你好，我是B，你能听到我吗？” (服务器回复一个SYN=1, ACK=1, seq=y, ack=x+1的报文)
    3.  **ACK**: A听到B的回答后，说：“我能听到你。” (客户端再发送一个ACK=1, seq=x+1, ack=y+1的报文)
    *   至此，双方都确认了对方的接收和发送能力都正常，连接建立。

*   **关闭连接：四次挥手 (Four-way Handshake)**
    *   **类比**: A和B结束通话。
    1.  **FIN**: A说：“我说完了，准备挂了。” (A发送一个FIN=1的报文)
    2.  **ACK**: B听到后，说：“好的，我知道了。但我可能还有几句话没说完，你等一下。” (B回复一个ACK)
    3.  **FIN**: B说完他最后的话后，也说：“我也说完了，可以挂了。” (B也发送一个FIN=1的报文)
    4.  **ACK**: A听到后，说：“好的，那我们都挂了吧。” (A回复一个ACK)
    *   至此，双方都同意关闭连接，连接断开。

---

### 4. 往返时间的估计与超时

TCP的可靠性依赖于**超时重传**机制。超时间隔的设置至关重要：太短会导致不必要的重传，太长会使网络对丢包的反应迟钝。TCP通过以下方式动态地估算超时间隔：

1.  **SampleRTT**: 测量一个已发送但未被重传的报文段从发送到收到其确认之间的时间。
2.  **EstimatedRTT (指数加权移动平均)**: 对多个SampleRTT进行平滑计算，得到一个更稳定的估计往返时间。
    `EstimatedRTT = (1-α) * EstimatedRTT + α * SampleRTT`
3.  **DevRTT (RTT偏差)**: 估算RTT的变化程度。
4.  **TimeoutInterval**: 最终的超时间隔通常设置为 `EstimatedRTT + 4 * DevRTT`，这样既考虑了平均延迟，也为网络波动留出了足够的余量。

---

### 5. 流量控制 (Flow Control)

*   **目的**: 这是一个**速度匹配**服务，确保发送方不会因为发送速度太快而淹没（即超出缓存能力）接收方。
*   **实现方式**:
    1.  接收方在其TCP连接的套接字中维护一个**接收缓存**。
    2.  接收方通过TCP首部中的**接收窗口（`rwnd`）**字段，告知发送方其缓存还有多少剩余空间。
    3.  发送方确保自己“已发送但未被确认的数据量”**不超过**接收方通告的`rwnd`值。
*   **问题**: 如果接收方通告`rwnd=0`，发送方会停止发送数据。此时如果接收方处理完数据后，发送了一个`rwnd`不为0的更新报文，但这个报文在网络中丢失了，双方就会陷入死锁。
*   **解决方案**: TCP规定，即使`rwnd=0`，发送方也会继续发送只有一个字节的“探测”报文，以确保能收到接收窗口的最新更新。
