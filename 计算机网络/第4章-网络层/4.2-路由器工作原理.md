# 4.2 路由器工作原理

路由器是网络层的核心设备，其主要作用是转发数据分组。理解路由器的内部工作原理，有助于我们理解网络性能瓶颈的来源。

---

### 1. 路由器体系结构

一个通用的路由器体系结构主要由四个组件构成：

*   **输入端口 (Input Ports)**
    *   **功能**: 这是分组进入路由器的物理入口。它执行多项任务：
        1.  **物理层功能**: 接收比特流。
        2.  **链路层功能**: 解封装，从帧中提取出IP数据报。
        3.  **网络层功能**: 在**转发表**中查找数据报的目的IP地址，以确定其应该被转发到哪个输出端口。然后将该输出端口信息传递给交换结构。
    *   转发表由路由选择处理器（控制平面）计算并下发。

*   **交换结构 (Switching Fabric)**
    *   **功能**: 这是路由器的“心脏”，负责将分组从输入端口**实际地**转移到输出端口。它的性能直接决定了路由器的转发能力。
    *   **实现方式**:
        1.  **基于内存的交换 (Switching via Memory)**: 最早期的实现方式。输入端口将分组复制到路由选择处理器的内存中，处理器再将其复制到对应的输出端口缓存。因为涉及CPU和内存总线，速度最慢，是现代路由器中的性能瓶颈。
        2.  **基于总线的交换 (Switching via a Bus)**: 输入端口将分组加上一个内部标签后，直接通过一条共享的总线广播给所有输出端口。只有与标签匹配的输出端口会接收并存储该分组。总线的带宽限制了交换能力。
        3.  **基于互联网络的交换 (Switching via an Interconnection Network)**: 也称为**纵横式交换（Crossbar Switch）**。这是一种更先进的结构，它通过一个由2N条总线组成的网格，能够并行地转发多个分组，只要它们的目的输出端口不同。这种方式性能最好，但成本也最高。

*   **输出端口 (Output Ports)**
    *   **功能**: 存储从交换结构接收到的分组，并最终通过物理链路将其发送出去。它也执行链路层和物理层的封装任务。
    *   **排队**: 如果从交换结构到达分组的速度超过了输出链路的发送能力，分组就必须在输出端口的**缓冲区（Buffer）**中排队等待。

*   **路由选择处理器 (Routing Processor)**
    *   **功能**: 这是路由器的“大脑”，执行**控制平面**的功能。
        1.  运行路由协议（如OSPF, BGP）。
        2.  与网络中其他路由器交换路由信息。
        3.  计算并维护路由表。
        4.  根据路由表生成并更新每个输入端口的**转发表**。

---

### 2. 输入端口排队

*   **发生原因**: 当交换结构的处理速度无法跟上所有输入端口接收分组的速度时，分组就必须在输入端口的缓冲区中排队。
*   **线路前部 (Head-of-the-Line, HOL) 阻塞**:
    *   **现象**: 假设输入端口A的队列中有两个分组，第一个要去往繁忙的输出端口X，第二个要去往空闲的输出端口Y。由于第一个分组因为等待X而被阻塞，导致排在它后面的第二个分组也无法被交换到空闲的Y端口，尽管Y端口此时完全有能力接收它。
    *   **后果**: HOL阻塞会严重降低路由器的整体性能，即使部分输出端口是空闲的。

---

### 3. 输出端口排队

*   **发生原因**: 当多个输入端口同时向同一个输出端口发送分组，或者交换结构向输出端口传送分组的速率超过了该输出链路的物理发送速率时，分组就必须在输出端口的缓冲区中排队。
*   **后果**:
    *   **排队时延增加**: 分组在缓冲区中等待的时间。
    *   **丢包 (Packet Loss)**: 如果缓冲区被填满，新到达的分组将被**丢弃**。
*   **缓冲区管理**:
    *   **重要性**: 缓冲区的大小对网络性能有重要影响。太小容易导致大量丢包，太大则可能引入过长的排队时延。
    *   **分组调度 (Packet Scheduling)**: 当队列中有多个分组等待发送时，由哪个分组先走？
        *   **先进先出 (First-In-First-Out, FIFO)**: 最简单的策略。
        *   **优先权排队 (Priority Queuing)**: 某些高优先级的分组（如实时通信）可以插队。
        *   **加权公平排队 (Weighted Fair Queuing, WFQ)**: 更复杂的策略，旨在为不同类型的流量公平地分配带宽。
