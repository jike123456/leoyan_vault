# 4.5 因特网中的路由

由于互联网的巨大规模和管理上的复杂性，单一的路由算法无法适用。因此，互联网采用**层次路由（Hierarchical Routing）**的策略，将全球网络划分为数万个**自治系统（AS）**。

---

### 1. 自治系统 (Autonomous Systems, AS)

*   **定义**: 一个AS是由单一技术管理部门（如一个大学、一个公司或一个ISP）所管辖的路由器和网络的集合。在AS内部，所有路由器运行相同的路由协议（IGP），并遵从统一的路由策略。
*   **AS号 (ASN)**: 每个AS都被分配一个全球唯一的16位或32位数字，即ASN。
*   **类比**: 可以将每个AS看作一个“国家”。每个国家内部有自己的交通规则和道路系统（IGP），而国家与国家之间则需要通过海关和边境口岸（边界路由器）进行连接，并遵循国际间的通行协议（EGP）。

---

### 2. 内部网关协议 (Interior Gateway Protocols, IGP)

IGP是在**同一个AS内部**使用的路由协议，其主要目标是在AS内部高效、准确地找到最短路径。

*   **RIP (Routing Information Protocol) - 路由信息协议**
    *   **类型**: 经典的**距离向量（DV）**协议。
    *   **度量标准**: **跳数（Hop Count）**。每经过一个路由器，跳数加1。最大跳数为15，超过15则认为目的地不可达。
    *   **特点**: 实现简单，但存在收敛慢、易产生路由环路（无穷计数问题）等缺点。目前已很少在新网络中使用。

*   **OSPF (Open Shortest Path First) - 开放最短路径优先**
    *   **类型**: 广泛使用的**链路状态（LS）**协议。
    *   **特点**:
        *   **开放**: 协议规范是公开的。
        *   **最短路径优先**: 使用Dijkstra算法计算最短路径。
        *   **安全性**: 所有OSPF报文都可以被认证，防止恶意篡改。
        *   **支持层次化**: 允许一个AS内部再划分为多个**区域（Area）**，以减少路由开销和提高扩展性。

---

### 3. 外部网关协议 (Exterior Gateway Protocols, EGP)

EGP用于在**不同AS之间**交换路由信息。互联网中事实上的标准EGP是BGP。

*   **BGP (Border Gateway Protocol) - 边界网关协议**
    *   **目标**: BGP的首要目标**不是**寻找最短路径，而是根据AS之间的商业和政治关系，**实施路由策略**。
    *   **类比**: 你从中国去美国，可能有多条航线。BGP选择哪条航线，不仅考虑飞行时间，更要考虑签证政策、航空公司之间的合作协议、是否经过某些特定国家等“策略”因素。
    *   **工作方式**:
        1.  **路径向量协议 (Path Vector Protocol)**: BGP在交换路由信息时，不仅仅是通告一个目的网络，而是通告到达该网络的**完整AS路径**。例如，AS1会向邻居通告：“要想到达网络X，你需要经过路径 `(AS2, AS3, AS4)`”。
        2.  **环路检测**: 这个路径信息使得环路检测非常简单。如果一个AS在收到的路径中看到了自己的ASN，它就知道这是一个环路，并会丢弃该路由。
        3.  **策略实施**: BGP允许网络管理员根据路径中的AS信息，灵活地制定路由策略。例如：
            *   “我不想为我的竞争对手ISP转发流量。”
            *   “所有去往欧洲的流量，我优先选择通过合作伙伴A，而不是B。”
    *   **BGP会话**: BGP通过TCP连接（端口179）在两个AS的边界路由器之间交换路由信息。

---

### 4. 广播和多播路由 (Broadcast and Multicast Routing)

*   **广播 (Broadcast)**
    *   **定义**: 网络层向一个子网内的**所有**主机发送一个分组。
    *   **实现**: 通常使用一个特殊的广播地址（如 `255.255.255.255`）。路由器通常不会转发广播分组，以防止“广播风暴”。

*   **多播 (Multicast)**
    *   **定义**: 将一个分组从单一源点发送给一个特定的**主机组**，这个组的成员可能分布在互联网的不同位置。
    *   **与广播的区别**: 广播是“一对所有”，而多播是“一对多（特定的一些）”。
    *   **优点**: 相比于给每个组成员都发送一份单独的数据（即多次单播），多播极大地节省了网络带宽。
    *   **应用**: 在线视频直播、多人视频会议、股票行情分发等。
    *   **多播路由算法**: 需要构建一个从源到所有组成员的**多播分发树**，确保分组能够被高效地复制和转发，而不会产生环路。
