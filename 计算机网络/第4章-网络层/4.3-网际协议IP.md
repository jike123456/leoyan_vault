# 4.3 网际协议 (Internet Protocol, IP)

IP协议是网络层的核心，它定义了数据在互联网中传输的基本单元——**数据报（Datagram）**——的格式，并规定了端系统和路由器如何处理这些数据报。目前，IPv4和IPv6是IP协议的两个主要版本。

---

### 1. IPv4

*   **IPv4 数据报格式**
    一个IPv4数据报由**首部（Header）**和**数据（Data）**两部分组成。首部通常为20字节。
    *   **版本 (Version)**: 标明IP协议版本，对IPv4该值为4。
    *   **首部长度**: 指示首部的长度。
    *   **总长度**: 整个IP数据报（首部+数据）的总长度。
    *   **标识、标志、片偏移**: 这三个字段用于**IP分片（Fragmentation）**。当一个大的IP数据报要通过一个最大传输单元（MTU）较小的链路时，路由器会将其分割成多个小的数据报（片），这些字段用于在目的主机上将这些片重新组装起来。
    *   **生存时间 (Time-to-Live, TTL)**: 每个路由器在转发数据报时，都会将TTL的值减1。如果TTL减到0，该数据报将被丢弃。这个机制可以防止数据报在网络中无限循环。
    *   **协议 (Protocol)**: 指示该数据报所承载的数据应交付给哪个上层运输层协议（如TCP的协议号为6，UDP的协议号为17）。
    *   **首部校验和**: 用于检测IP首部在传输过程中是否出错。
    *   **源IP地址** 和 **目的IP地址**: 32位的地址，标识了发送和接收主机。

*   **IPv4 编址**
    一个IP地址由**网络部分**和**主机部分**组成。
    *   **子网划分 (Subnetting)**: 允许一个组织内部将其获得的较大地址块，划分为多个更小的、独立的**子网（Subnet）**。一个子网中的设备可以不经过路由器直接相互通信。子网掩码（Subnet Mask）用于区分IP地址中的网络部分和主机部分。
    *   **无类别域间路由 (Classless Interdomain Routing, CIDR)**: 抛弃了传统的A、B、C类地址的划分，使用 `a.b.c.d/x` 的格式来表示地址块，其中 `x` 表示地址中网络部分的位数。CIDR使得IP地址的分配和路由聚合更加灵活高效。

---

### 2. 地址管理与转换

*   **动态主机配置协议 (DHCP - Dynamic Host Configuration Protocol)**
    *   **目的**: 解决手动配置IP地址的繁琐和易错问题。
    *   **功能**: 允许一个主机在加入网络时，自动地从DHCP服务器获取一个IP地址、子网掩码、默认网关地址和本地DNS服务器地址。它是一个即插即用的协议。

*   **网络地址转换 (NAT - Network Address Translation)**
    *   **动机**: 解决IPv4地址严重短缺的问题。
    *   **工作原理**: 允许一个机构内部（如家庭、公司）的所有设备使用私有IP地址（如 `192.168.1.x`），而对外共享同一个公网IP地址。
    *   **类比**: 想象一个公司的总机电话。公司内部每个员工都有一个分机号（私有IP），但对外只有一个统一的总机号码（公网IP）。当员工向外打电话时，对方看到的来电显示是总机号码。当外部有人打总机号码找某个员工时，需要先告诉总机小姐要转接哪个分机号（**端口号**）。
    *   **实现**: NAT路由器维护一个**NAT转换表**，记录 `(私有IP, 私有端口)` 到 `(公网IP, 公网端口)` 的映射关系。

---

### 3. IPv6

*   **动机**: IPv4地址空间（约40亿个）已完全耗尽，无法满足互联网设备的爆炸式增长。
*   **优点**:
    *   **巨大的地址空间**: 使用128位地址，数量几乎是无限的。
    *   **简化的首部**: 移除了一些不必要的或很少使用的字段，使得路由器处理速度更快。
    *   **更好的扩展性与安全性**: 支持更好的服务质量（QoS）和内置的IPsec安全支持。
*   **IPv6数据报格式**: 拥有一个固定的40字节基本首部，并将不常用的功能（如分片）放入可选的扩展首部中。
*   **与IPv4的转换**: 由于不可能在一夜之间完成全球网络的升级，IPv4和IPv6将在很长一段时间内共存。主要的转换技术包括：
    *   **双栈 (Dual-stack)**: 节点同时拥有IPv4和IPv6地址，并能处理两种协议。
    *   **隧道 (Tunneling)**: 将IPv6数据报作为载荷，封装在一个IPv4数据报中，以便在IPv4网络中传输。

---

### 4. 软件定义网络 (SDN)

SDN是对传统网络架构的一次革新，其核心思想是将**控制平面**与**数据平面**分离。

*   **传统网络**: 每台路由器都独立运行自己的控制平面（路由算法）和数据平面（转发）。
*   **SDN网络**:
    *   **数据平面**: 路由器（或交换机）只负责根据**流表（Flow Table）**进行简单、快速的转发。
    *   **控制平面**: 由一个远程的、逻辑上集中的**SDN控制器**负责。控制器拥有整个网络的全局视图，负责计算路由、制定策略，并将生成的流表下发到各个网络设备。
    *   **通信接口**: 控制器通过一个标准的南向接口（如OpenFlow）与网络设备进行通信。

SDN使得网络管理更加灵活、可编程和创新。
