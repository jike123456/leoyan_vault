# 第4章 网络层 (The Network Layer)

网络层是协议栈的核心，它解决了如何将数据分组跨越多个网络、从任何源主机发送到任何目的主机的根本问题。如果说运输层负责的是“进程到进程”的端到端通信，那么网络层负责的是“主机到主机”的广域通信。

## 核心内容

### 1. 网络层概述
*   **核心功能：转发与路由**
    *   **转发 (Forwarding)**: 这是一个**局部**行为，指路由器根据其转发表，将到达输入端口的分组转移到正确的输出端口。这就像一个十字路口的交警，根据车辆的目的地，指挥它该走哪个出口。
    *   **路由 (Routing)**: 这是一个**全局**行为，指通过路由算法计算并决定分组从源到目的地所经过的路径。这就像使用地图规划从北京到上海的最佳行车路线。
*   **数据平面与控制平面**
    *   **数据平面**: 主要任务是**转发**。它处理的是每个到达路由器的数据报，速度极快。
    *   **控制平面**: 主要任务是**路由**。它负责运行路由协议，维护路由表。近年来，**软件定义网络 (SDN)** 的一个核心思想就是将控制平面从路由器中分离出来，进行集中式管理。

### 2. 路由器工作原理
路由器是网络层的关键设备，其内部结构主要包括：
*   **输入端口**: 物理地接收信号，并从中提取出数据报。它会查找转发表以决定数据报的去向，并将其送往交换结构。
*   **交换结构**: 路由器的“心脏”，负责将数据报从输入端口实际地转移到输出端口。
*   **输出端口**: 存储从交换结构接收到的数据报，并在合适的时机通过物理链路发送出去。如果发送速度跟不上交换结构送来的速度，就会在这里发生**排队**和**丢包**。

### 3. 网际协议 (IP - Internet Protocol)
IP协议是网络层的核心协议，它定义了数据报的格式和端系统、路由器用于交换它们的规则。
*   **IPv4**:
    *   **数据报格式**: 包含源IP地址、目的IP地址、生存时间(TTL)、上层协议号等关键信息。
    *   **编址**: 使用32位地址。为了有效管理地址，引入了**子网划分**和**无类别域间路由 (CIDR)**。
    *   **地址获取**: **DHCP (动态主机配置协议)** 允许主机自动获取IP地址。
    *   **地址短缺解决方案**: **NAT (网络地址转换)** 允许多台设备共享一个公网IP地址，极大地延缓了IPv4地址的耗尽。
*   **IPv6**:
    *   为了解决IPv4地址耗尽的问题而诞生，使用128位地址。它还带来了简化的首部、更好的安全支持等优点。

### 4. 路由算法
路由算法的目标是为数据报在网络中找到一条从源到目的地的“好”路径（通常指成本最低的路径）。
*   **链路状态 (Link-State, LS) 算法**:
    *   **代表**: Dijkstra算法。
    *   **思想**: 每个路由器都拥有整个网络的完整拓扑图，并独立地在本地计算出到所有其他节点的最短路径。就像每个人都有一张完整的地图。
    *   **应用**: OSPF协议。
*   **距离向量 (Distance-Vector, DV) 算法**:
    *   **代表**: Bellman-Ford算法。
    *   **思想**: 每个路由器只知道到其直接邻居的距离。它通过与邻居不断地交换路由信息（“我的路由表告诉你”），逐步地、迭代地计算出到所有目的地的最短路径。就像问路，你只问你的邻居：“去火车站怎么走最近？”
    *   **应用**: RIP协议。

### 5. 因特网中的路由
互联网规模巨大，单一的路由算法无法适用。因此，互联网采用**层次路由**，将其划分为多个**自治系统 (Autonomous Systems, AS)**。
*   **自治系统 (AS)**: 一个由单一组织管理、具有统一路由策略的路由器网络（例如一个ISP或一个大型公司网络）。
*   **内部网关协议 (IGP)**: 在**同一个AS内部**运行的路由协议。
    *   **OSPF (开放最短路径优先)**: 基于LS算法，是当今最常用的IGP之一。
    *   **RIP (路由信息协议)**: 基于DV算法，较老，已逐渐被OSPF取代。
*   **外部网关协议 (EGP)**: 在**不同AS之间**运行的路由协议。
    *   **BGP (边界网关协议)**: 互联网事实上的标准EGP。它不仅仅是寻找最短路径，更重要的是，它允许每个AS实施自己的**路由策略**（例如，“我的网络不愿意为邻居B转发去往C的数据”）。

本章揭示了数据包在互联网这个巨大的网络迷宫中如何找到路径并被正确转发的核心机制，是理解互联网全局通信的关键。
