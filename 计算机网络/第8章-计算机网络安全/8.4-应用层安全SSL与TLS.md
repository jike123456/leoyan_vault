# 8.4 运输层安全：SSL与TLS

安全套接字层（SSL, Secure Sockets Layer）及其后继者——传输层安全（TLS, Transport Layer Security）是当今互联网上应用最广泛的安全协议。它在TCP之上、应用层之下提供了一个安全的通道，我们每天使用的HTTPS就是基于TLS实现的。

---

### 1. SSL/TLS 的目标

TLS旨在为任意基于TCP的客户端/服务器应用程序提供三个核心的安全服务：

1.  **机密性 (Confidentiality)**: 通过加密，确保客户端和服务器之间的通信内容不被窃听。
2.  **完整性 (Integrity)**: 通过报文认证码（MAC），确保通信内容在传输过程中不被篡改。
3.  **认证 (Authentication)**: 允许客户端验证服务器的身份（甚至服务器也可以验证客户端的身份），防止中间人攻击。

**定位**: TLS位于应用层和运输层之间。对于应用层来说，它就像一个普通的TCP套接字，应用程序将明文数据写入TLS套接字；TLS负责对数据进行加密，然后将加密后的数据传递给TCP套接字进行传输。

---

### 2. TLS 协议的组成

TLS协议本身由两个主要的子协议组成：**握手协议**和**记录协议**。

### 3. TLS 握手协议 (Handshake Protocol)

这是TLS中最复杂也最关键的部分。其目标是让客户端和服务器在开始交换应用数据**之前**，安全地完成身份认证并协商出一个共享的**会话密钥（Session Key）**。

**类比**: 想象一下两位特工在交换机密情报前，需要通过一系列复杂的、预先约定的暗号和流程来确认对方的身份，并商定本次谈话使用的“密码本”（会话密钥）。

**简化的握手流程**:
1.  **客户端 "Hello"**: 客户端向服务器发送一个"Hello"报文，其中包含了它支持的密码学算法列表和一个随机数。
2.  **服务器 "Hello" 与证书**:
    *   服务器从客户端的算法列表中选择一套加密算法（如AES用于对称加密，RSA用于密钥交换，SHA-256用于MAC）。
    *   服务器将自己的选择、一个服务器生成的随机数，以及最重要的——它的**数字证书**，一同发送给客户端。这个证书中包含了服务器的公钥，并由一个受信任的CA签名。
3.  **客户端验证与密钥生成**:
    *   **验证证书**: 客户端的浏览器检查收到的证书。它使用其内置的CA公钥来验证证书的签名是否有效，并检查证书中的域名是否与正在访问的域名匹配。
    *   **生成预主密钥**: 如果证书验证通过，客户端就相信了服务器的身份。然后，客户端生成一个随机的秘密字符串，称为“**预主密钥（Pre-Master Secret）**”。
    *   **加密预主密钥**: 客户端用从服务器证书中获得的**服务器公钥**来加密这个预主密钥，并将其发送给服务器。
4.  **服务器生成会话密钥**:
    *   服务器收到加密的预主密钥后，用自己的**私钥**进行解密。
    *   现在，客户端和服务器双方都拥有了相同的三个秘密信息：客户端随机数、服务器随机数和预主密钥。
5.  **生成会话密钥**: 双方使用这三个秘密信息，通过一个预先商定的算法，独立地计算出完全相同的**会话密钥**。这个会话密钥是一个**对称密钥**，将用于加密后续的所有通信。
6.  **完成握手**: 双方互相发送一个“finished”报文，该报文使用刚生成的会话密钥进行加密和认证。如果双方都能成功解密并验证对方的“finished”报文，则握手成功，安全通道建立。

---

### 4. TLS 记录协议 (Record Protocol)

一旦握手完成，双方就开始使用记录协议来传输应用数据。

*   **工作方式**:
    1.  发送方（如客户端）将应用层报文（如HTTP请求）分割成小的数据块。
    2.  为每个数据块计算一个**报文认证码（MAC）**，并附加在后面。
    3.  使用握手阶段生成的**对称会话密钥**，对“数据块+MAC”进行加密。
    4.  将加密后的数据传递给TCP进行传输。
*   **接收方**: 执行相反的过程，先用会话密钥解密，然后验证MAC以确保完整性，最后将原始数据块重组后交给应用层。

---

### 5. HTTPS

HTTPS (HTTP over SSL/TLS) 并不是一个新的协议，它只是简单地指示浏览器使用TLS来加密其与Web服务器之间的HTTP通信。
*   **URL**: 使用 `https://` 开头。
*   **端口**: 默认使用TCP端口 `443`。
当你在浏览器地址栏看到一把锁的图标时，就意味着你与该网站之间的连接正受到TLS的保护。
