# 8.3 报文完整性与数字签名

除了机密性（防止窃听），我们还需要确保报文在传输过程中没有被篡改（**完整性**），并且能够验证报文的来源（**认证**）。本节介绍实现这些目标的关键密码学工具。

---

### 1. 密码散列函数 (Cryptographic Hash Functions)

散列函数是实现完整性的基础。

*   **功能**: 接收一个任意长度的输入报文，经过计算后，输出一个固定长度的字符串，这个输出被称为**散列值**或**报文摘要 (Message Digest)**。
*   **类比**: 就像为一份文件计算一个独特的“**数字指纹**”。
*   **关键特性**:
    1.  **单向性 (One-way property)**: 从报文`m`计算出其散列值`H(m)`很容易，但从散列值`H(m)`反向计算出原始报文`m`在计算上是不可行的。
    2.  **抗碰撞性 (Collision resistance)**: 找到两个不同的报文`m1`和`m2`，使得它们的散列值相同（即`H(m1) = H(m2)`），在计算上是不可行的。
*   **如何用于完整性检查**:
    *   发送方计算报文`m`的散列值`H(m)`，并将`(m, H(m))`一起发送出去。
    *   接收方收到`(m', H(m'))`后，自己重新计算`m'`的散列值`H(m')`。
    *   如果`H(m')`与收到的`H(m)`相同，则可以高度确信报文在传输中没有被篡改。
*   **常见算法**: MD5, SHA-1, SHA-256 (MD5和SHA-1已被证明存在安全弱点，不再推荐使用)。

---

### 2. 报文认证码 (Message Authentication Code, MAC)

散列函数本身只能保证完整性，但不能保证**来源认证**。因为攻击者可以篡改报文，重新计算散列值，然后一起发送。为了解决这个问题，引入了MAC。

*   **功能**: 提供**报文完整性**和**来源认证**。
*   **工作原理**:
    1.  发送方和接收方共享一个**秘密的认证密钥 `s`**。
    2.  发送方将报文`m`和密钥`s`串联起来，然后计算其散列值，即 `MAC = H(m+s)`。
    3.  发送方将报文`m`和这个`MAC`一起发送给接收方。
*   **验证**:
    *   接收方收到`(m, MAC)`后，用自己保存的共享密钥`s`，与收到的报文`m`串联，重新计算`H(m+s)`。
    *   如果计算结果与收到的`MAC`相同，接收方不仅可以确信报文未被篡改（完整性），还可以确信该报文确实来自共享同一密钥的发送方（认证）。因为不知道密钥`s`的攻击者无法伪造出正确的MAC。
*   **类比**: 就像在信件的封蜡上，不仅盖上了通用的邮戳，还盖上了一个只有你和收信人才认识的**私人印章（共享密钥）**。

---

### 3. 数字签名 (Digital Signatures)

MAC解决了认证问题，但它基于共享密钥，因此无法实现**不可否认性**（因为接收方也可以生成相同的MAC）。数字签名使用公钥密码学来解决这个问题。

*   **功能**: 提供**来源认证**、**报文完整性**和**不可否认性**。
*   **工作原理 (签名)**:
    1.  发送方首先计算报文`m`的散列值`H(m)`。
    2.  然后，发送方使用自己的**私钥**对这个散列值进行加密，得到的结果就是**数字签名**。
    3.  发送方将原始报文`m`和这个数字签名一起发送出去。
*   **工作原理 (验证)**:
    1.  接收方收到报文和签名后，首先用发送方的**公钥**对数字签名进行解密，得到一个散列值，我们称之为`H1`。
    2.  接收方再独立地计算收到的报文`m`的散列值，得到`H2`。
    3.  如果`H1`与`H2`完全相同，则签名验证成功。
*   **如何实现安全属性**:
    *   **认证**: 只有真正的发送方才拥有其私钥，所以只有他能生成可以被其公钥成功解密的签名。
    *   **完整性**: 如果报文被篡改，`H2`就会与`H1`不同。
    *   **不可否认性**: 因为只有发送方拥有私钥，所以他不能否认自己签署（发送）了该报文。
*   **类比**: 相当于手写签名。你的签名是独一无二的（私钥），别人可以辨认你的笔迹（公钥）来确认这份文件确实是你签署的。

---

### 4. 公钥基础设施 (Public Key Infrastructure, PKI)

公钥密码学（包括数字签名）的一个核心问题是：我如何确信我拿到的这个公钥确实是属于“张三”的，而不是一个冒名顶替者“李四”的？PKI就是为了解决这个问题而设计的。

*   **证书颁发机构 (Certificate Authority, CA)**:
    *   一个受信任的第三方机构，其作用是为实体（如个人、网站、公司）的身份和其公钥进行“背书”。
    *   当CA验证了一个实体的身份后，它会用自己的**私钥**对该实体的**公钥**以及一些身份信息进行签名，生成一份**数字证书**。
*   **数字证书**:
    *   **内容**: 包含了一个实体的公钥、该实体的身份信息（如网站域名），以及CA的数字签名。
    *   **作用**: 当你访问一个HTTPS网站时，该网站会向你的浏览器出示它的数字证书。你的浏览器（内置了所有主流CA的公钥）会使用CA的公钥来验证证书上的签名。如果验证成功，浏览器就确信证书中的公钥确实是属于该网站的。
*   **类比**: CA就像是**公安局**。数字证书就像是**身份证**。身份证上有你的照片和个人信息（身份信息），并盖有公安局的公章（CA的签名）。我们信任公安局，所以我们也信任它颁发的、盖有公章的身份证。
